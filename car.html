<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ciche WzgÃ³rze â€” Poranek (skrÃ³t)</title>
<style>
  :root{ --bg:#07090c; --fg:#e6e6e6; --muted:#9aa0a6; --accent:#c7a26d; --panel:rgba(255,255,255,.04); --line:rgba(255,255,255,.08); }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:radial-gradient(1200px 800px at 70% -10%, #11161e 0%, #07090c 60%, #05070a 100%); color:var(--fg); font:16px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Ubuntu,Cantarell}
  .wrap{max-width:920px; margin:0 auto; padding:24px 16px 120px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px}
  h1{font-size:20px; margin:0; letter-spacing:.02em; color:#f1f1f1}
  .pill{display:inline-flex; gap:6px; align-items:center; padding:.25em .6em; border:1px solid rgba(255,255,255,.12); border-radius:999px; font-size:12px; color:#cbd5e1; margin-right:6px}
  .pill strong{color:#fff; font-weight:700}
  .panel{background:var(--panel); border:1px solid var(--line); border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,.35); display:flex; flex-direction:column;}
  #log{height:60vh; min-height:340px; overflow:auto; padding:18px 18px 6px; scrollbar-width:thin}
  #log::-webkit-scrollbar{height:8px; width:8px}
  #log::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1); border-radius:20px}
  .line{margin:0 0 14px; opacity:.96}
  .type{border-right:2px solid rgba(255,255,255,.65); animation:caret .85s steps(1) infinite}
  @keyframes caret{50%{border-color:transparent}}
  .toolbar{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:14px; padding:10px 12px; border-top:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02))}
  input[type=range]{accent-color:#b5c4ff}
  button{padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,.06); color:var(--fg); cursor:pointer}
  button:hover{background:rgba(255,255,255,.1)}
  .sep{opacity:.35; margin:0 .25em}
  #inputbar{display:flex; gap:10px; padding:10px; border-top:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02))}
  #cmd{flex:1; padding:12px 14px; border-radius:10px; border:1px solid var(--line); background:rgba(3,6,9,.6); color:var(--fg); outline:none}
  #cmd::placeholder{color:#8892a6}
  .note{color:var(--muted); font-size:13px}
  .accent{color:var(--accent); font-weight:600}
  .overlay-diary { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.6); backdrop-filter: blur(2px); z-index: 9999; }
  .overlay-diary.open { display: grid; }
  .overlay-diary .box { width: min(960px, 95vw); height: min(640px, 85vh); background: rgba(10,12,16,.96); border: 1px solid rgba(255,255,255,.12); border-radius: 14px; overflow: hidden; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,.6); }
  .overlay-diary .box header { position:absolute; inset:0 auto auto 0; width:100%; height:42px; display:flex; align-items:center; justify-content:space-between; padding: 0 10px; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border-bottom: 1px solid rgba(255,255,255,.08); font-size: 14px; color:#cbd5e1; }
  .overlay-diary .close { border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:#e6e6e6; border-radius: 8px; padding:6px 10px; cursor:pointer; }
  .overlay-diary iframe { position:absolute; inset:42px 0 0 0; border:0; width:100%; height:calc(100% - 42px); background:#000; }

  /* === SANITY FX (CSS) === */
  #sanFx{position:fixed; inset:0; pointer-events:none; z-index:50}
  #sanFx .vig{position:absolute; inset:-10%; background:
    radial-gradient(70% 70% at 50% 50%, transparent 45%, rgba(0,0,0,.65) 100%);
    opacity:0; transition:opacity .35s ease}
  #sanFx .scan{position:absolute; inset:0;
    background:repeating-linear-gradient(to bottom, rgba(255,255,255,.035) 0 2px, rgba(0,0,0,0) 2px 4px);
    mix-blend-mode:overlay; opacity:0; transition:opacity .35s ease}
  body.san-t2 .panel{filter:saturate(.9) contrast(1.03)}
  body.san-t3 .panel{filter:hue-rotate(-6deg) saturate(.85) contrast(1.06)}
  body.san-t4 .panel{filter:hue-rotate(-12deg) saturate(.75) contrast(1.1) blur(.3px)}
  body.san-t5 .panel{filter:hue-rotate(-18deg) saturate(.6) contrast(1.18) blur(.6px)}
  body.san-t3 #sanFx .vig{opacity:.28}
  body.san-t4 #sanFx .vig{opacity:.5}
  body.san-t5 #sanFx .vig{opacity:.72}
  body.san-t4 #sanFx .scan{opacity:.15}
  body.san-t5 #sanFx .scan{opacity:.28}
  @keyframes sanJitter { 0%,97%,100%{transform:translate3d(0,0,0)} 98%{transform:translate3d(.6px,-.6px,0)} 99%{transform:translate3d(-.7px,.5px,0)} }
  body.san-t4 .panel, body.san-t5 .panel { animation:sanJitter 7.5s infinite }
  body.san-t5 #log .line{ text-shadow:1px 0 rgba(255,0,0,.28), -1px 0 rgba(0,255,255,.22); }
</style>
</head>
<body>
  <div id="sanFx" aria-hidden="true">
    <div class="vig"></div>
    <div class="scan"></div>
  </div>

  <div class="wrap">
    <header>
      <h1>Ciche WzgÃ³rze â€” Poranek</h1>
      <div>
        <span class="pill" id="sanBadge" title="PoczytalnoÅ›Ä‡ (SAN)"><strong>SAN</strong>&nbsp;<span id="sanVal">â€”</span></span>
      </div>
    </header>

    <section class="panel">
      <div id="log" aria-live="polite"></div>
      <div class="toolbar">
        <button id="fast">Przyspiesz</button>
        <span class="sep">|</span>
        <span>Tempo</span>
        <input type="range" id="speed" min="0" max="3" step="1" value="3" />
        <span id="speedLabel">powoli</span>
        <span class="sep">|</span>
        <button id="restart">Restart</button>
        <button id="next" disabled>NastÄ™pny plik</button>
      </div>
      <div id="inputbar">
        <input id="cmd" autocomplete="off" spellcheck="false" placeholder="wpisz komendÄ™â€¦" />
        <button id="send">WyÅ›lij</button>
      </div>
    </section>
    <p class="note" id="hint" style="display:none"></p>
  </div>

  <div id="diaryOverlay" class="overlay-diary" aria-hidden="true">
    <div class="box">
      <header>
        <span>ğŸ““ PamiÄ™tnik â€” coÅ› siÄ™ w nim zmieniaâ€¦</span>
        <button class="close" id="closeDiary">Zamknij</button>
      </header>
      <iframe id="diaryFrame" src="about:blank" title="PamiÄ™tnik"></iframe>
    </div>
  </div>

  <div id="flyerOverlay" class="overlay-diary" aria-hidden="true">
    <div class="box">
      <header>
        <span>ğŸ“° Ulotka â€” interakcja</span>
        <button class="close" id="closeFlyer">Zamknij</button>
      </header>
      <iframe id="flyerFrame" src="about:blank" title="Ulotka interaktywna"></iframe>
    </div>
  </div>

<script src="sanity.js"></script>
<script>
/* === SAN PERSIST (localStorage) === */
(() => {
  const SAN_KEY = "cw.san.v1";
  const clamp = v => Math.max(0, Math.min(100, v|0));
  const loadSAN = () => {
    const raw = localStorage.getItem(SAN_KEY);
    const n = +raw;
    return Number.isFinite(n) ? clamp(n) : 100;
  };
  const saveSAN = v => { try{ localStorage.setItem(SAN_KEY, String(clamp(v))); }catch(e){} };

  window.SAN = {
    key: SAN_KEY,
    load: loadSAN,
    save: saveSAN,
    reset(v=100){ try{ localStorage.removeItem(SAN_KEY); }catch(e){}; saveSAN(v); if (window.Sanity?.set) Sanity.set(v); }
  };

  window.addEventListener("storage", (e) => {
    if (e.key === SAN_KEY && e.newValue != null && window.Sanity?.set) {
      const next = clamp(+e.newValue);
      if (Number.isFinite(next) && window.Sanity?.get && Sanity.get() !== next) {
        Sanity.set(next);
      }
    }
  });
})();
</script>
<script src="inventory.js"></script>

<script>
(() => {
  const NEXT_FILE = "station.html";

  const SPEEDS = [0, 2, 10, 60];
  let speedIdx = 3;
  const labels = ["natychmiast","szybko","standard","powoli"];

  const log = document.getElementById('log');
  const speed = document.getElementById('speed');
  const speedLabel = document.getElementById('speedLabel');
  const fastBtn = document.getElementById('fast');
  const restartBtn = document.getElementById('restart');
  const nextBtn = document.getElementById('next');
  const cmd = document.getElementById('cmd');
  const send = document.getElementById('send');
  const hint = document.getElementById('hint');

  let queue = Promise.resolve();
  let sanTypeFactor = 1;
  function scrollBottom(){ log.scrollTop = log.scrollHeight; }
  function writeLine(html=""){ const d=document.createElement('div'); d.className='line'; d.innerHTML=html; log.appendChild(d); scrollBottom(); return d; }
  function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
  function promptEcho(t){ writeLine("&gt; " + escapeHtml(t)); }

  function typeText(text){
    queue = queue.then(async () => {
      const d = writeLine("");
      const s = document.createElement('span'); s.className="type"; d.appendChild(s);
      const ms = Math.max(0, Math.round(SPEEDS[speedIdx] * sanTypeFactor));
      const str = String(text ?? "");
      if(ms<=0){ s.textContent=str; s.classList.remove('type'); return; }
      for(const ch of str){ s.textContent += ch; await new Promise(r=>setTimeout(r, ms)); scrollBottom(); }
      s.classList.remove('type');
    });
    return queue;
  }
  async function say(lines, gap=350){ for(const l of lines){ await typeText(l); if(gap) await new Promise(r=>setTimeout(r,gap)); } }

  /* ===== SANITY bootstrap ===== */
  const sanValEl = document.getElementById("sanVal");
  let sanWhisperTimer = null;
  let sanScrambleTimer = null;

  function tierFor(v){ return v>=80?1 : v>=60?2 : v>=40?3 : v>=20?4 : 5; }
  function applySanityTier(t){
    document.body.classList.remove('san-t1','san-t2','san-t3','san-t4','san-t5');
    document.body.classList.add('san-t'+t);
    sanTypeFactor = [1.0, 0.95, 0.9, 0.85, 0.8][t-1] || 1;

    if (sanWhisperTimer) { clearInterval(sanWhisperTimer); sanWhisperTimer = null; }
    if (t >= 4) {
      sanWhisperTimer = setInterval(()=>{
        if (Math.random() < 0.35) {
          const pool = ["â€¦to nie onaâ€¦","â€¦nie odwracaj siÄ™â€¦","â€¦sÅ‚yszysz?â€¦","â€¦nie jesteÅ› samâ€¦","â€¦znowu patrzÄ…â€¦"];
          writeLine(`<span style="color:#aeb4bd;font-style:italic;opacity:.8">${pool[Math.floor(Math.random()*pool.length)]}</span>`);
        }
      }, 9000);
    }

    if (sanScrambleTimer) { clearInterval(sanScrambleTimer); sanScrambleTimer = null; }
    if (t === 5) {
      sanScrambleTimer = setInterval(()=> scrambleLogOnce(0.10, 160), 900);
    }
  }
  function scrambleLogOnce(intensity=0.10, duration=150){
      const spans = log?.querySelectorAll('.line span, .line') || [];
      if (!spans.length) return;
      const target = spans[Math.floor(Math.random()*spans.length)];
      const original = target.textContent;
      if (!original || original.length < 2) return;
      const idx = Math.max(1, Math.floor(original.length * intensity));
      let chars = original.split('');
      for (let i = 0; i < idx; i++) {
        const p = Math.floor(Math.random() * chars.length);
        if (!/\s/.test(chars[p])) {
          const code = chars[p].codePointAt(0);
          chars[p] = String.fromCodePoint(code + 1);
        }
      }
      target.textContent = chars.join('');
      setTimeout(() => { target.textContent = original; }, duration + Math.floor(Math.random()*120));
  }
  function syncSan(v){
    if (sanValEl) sanValEl.textContent = `${v}/100`;
    applySanityTier(tierFor(v));
  }
  if (window.Sanity && typeof Sanity.init === "function") {
    const _startSAN = (window.SAN?.load ? window.SAN.load() : 100);
    Sanity.init({ start: _startSAN, mount: ".toolbar" });
    const _onSanChange = (v)=>{ try{ window.SAN?.save?.(v); }catch(e){}; syncSan(v); };
    if (typeof Sanity.subscribe === "function")     Sanity.subscribe(_onSanChange);
    else if (typeof Sanity.onChange === "function")  Sanity.onChange(_onSanChange);
    syncSan(Sanity.get?.() ?? _startSAN);
  } else {
    syncSan(window.SAN?.load?.() ?? 100);
  }
  if (window.Sanity && typeof Sanity.wrapTypeText === "function") {
    const _origType = typeText;
    typeText = (txt)=> (Sanity.get && Sanity.get()<20 ? Sanity.wrapTypeText(_origType)(txt) : _origType(txt));
  }

  let available = [];
  function setCmds(arr){
    available = arr.slice();
    if(!available.includes("ekwipunek")) available.push("ekwipunek");
    showHint();
  }
  function addCmd(c){
    if(!available.includes(c)){
      available.push(c);
      if(!available.includes("ekwipunek")) available.push("ekwipunek");
      showHint();
    }
  }
  function removeCmd(c){
    const i = available.indexOf(c);
    if(i>-1){
      available.splice(i,1);
      showHint();
    }
  }
  
  function consumeCmd(canonCmd){
    removeCmd(canonCmd);
  }
  
  function showHint(){
    hint.style.display="block";
    hint.innerHTML="Komendy: " + (available.length ? available.map(c=>"<b>"+escapeHtml(c)+"</b>").join(", ") : "â€”") + ".";
  }

  const SM = {
    current: null,
    scenes: {},
    reg(n, o){ this.scenes[n] = o; },
    async go(n){
      if(this.current && this.scenes[this.current]?.exit){ this.scenes[this.current].exit(); }
      this.current = n;
      if(this.scenes[n]?.enter){ await this.scenes[n].enter(); }
    },
    handle(t){
      const S = this.scenes[this.current];
      if(!S || !S.handle) return false;
      return !!S.handle(t);
    }
  };

  const G = {
    washed:false, dressed:false, leftHome:false, brushed:false, hungry:false, diaryUnlocked:false,
    heardOnce:false, checkedMailbox:false, pinched:false, lightPressed:false,
    sawStains:false, lookedViewer:false, readNotice:false, sniffed:false, countedSteps:false,
    knocked12:false, elevatorDead:true,
    preConversationCmds: [],
  };

  function openDiaryGame() {
    const ov = document.getElementById('diaryOverlay');
    const fr = document.getElementById('diaryFrame');
    fr.src = 'diary.html';
    ov.classList.add('open');
    ov.setAttribute('aria-hidden','false');
  }
  function closeDiaryGame() {
    const ov = document.getElementById('diaryOverlay');
    const fr = document.getElementById('diaryFrame');
    ov.classList.remove('open');
    ov.setAttribute('aria-hidden','true');
    fr.src = 'about:blank';
  }
  document.addEventListener('DOMContentLoaded', () => {
    const ov = document.getElementById('diaryOverlay');
    const btn = document.getElementById('closeDiary');
    btn?.addEventListener('click', closeDiaryGame);
    ov?.addEventListener('click', (e) => { if (e.target === ov) closeDiaryGame(); });
  });
  
  function handleOpenDiary(canonStr){
    if (canonStr === "czytaj pamiÄ™tnik" && G.diaryUnlocked) {
      openDiaryGame();
      consumeCmd("czytaj pamiÄ™tnik");
      return true;
    }
    return false;
  }

  function openFlyerGame(){
    const ov = document.getElementById('flyerOverlay');
    const fr = document.getElementById('flyerFrame');
    fr.src = 'ulotka-gra.html';
    ov.classList.add('open');
    ov.setAttribute('aria-hidden','false');
  }
  
  // ZMIANA: Dodano tekst po zamkniÄ™ciu minigry
  function closeFlyerGame(){
    const ov = document.getElementById('flyerOverlay');
    const fr = document.getElementById('flyerFrame');
    ov.classList.remove('open');
    ov.setAttribute('aria-hidden','true');
    fr.src = 'about:blank';
    typeText("Co to byÅ‚o? Chyba znowu masz halucynacje...");
  }
  document.addEventListener('DOMContentLoaded', () => {
    const ov = document.getElementById('flyerOverlay');
    const btn = document.getElementById('closeFlyer');
    btn?.addEventListener('click', closeFlyerGame);
    ov?.addEventListener('click', (e) => { if (e.target === ov) closeFlyerGame(); });
  });
  window.addEventListener('message', (e) => {
    if (e.data === 'closeUlotkaMinigame') closeFlyerGame();
  });
  
  function handleOpenFlyer(canonStr){
    if (canonStr === "otwÃ³rz ulotkÄ™") {
      if (G.board?.read?.sekta) {
        openFlyerGame();
        consumeCmd("otwÃ³rz ulotkÄ™");
      } else {
        writeLine("<span class='accent'>Najpierw przeczytaj ulotkÄ™ (â€czytaj ulotkÄ™â€).</span>");
      }
      return true;
    }
    return false;
  }

  const ALIAS = {
    "rozejrzyj siÄ™":["rozejrzyj siÄ™","rozejrzyj","spÃ³jrz"],
    "umyj siÄ™":["umyj siÄ™","umyj sie","umyj twarz"],
    "umyj zÄ™by":["umyj zÄ™by","umyj zeby","wyszczotkuj zÄ™by","wyszczotkuj zeby","umyj zeby szczoteczkÄ…","umyj zeby szczoteczka"],
    "ubierz siÄ™":["ubierz siÄ™","ubierz sie","przebierz siÄ™","przebierz sie"],
    "sprawdÅº lodÃ³wkÄ™":["sprawdÅº lodÃ³wkÄ™","sprawdz lodowke","lodÃ³wka","lodowka","otwÃ³rz lodÃ³wkÄ™","otworz lodowke","zajrzyj do lodÃ³wki","zajrzyj do lodowki"],
    "wyjdÅº z mieszkania":["wyjdÅº z mieszkania","wyjdz z mieszkania","wyjdÅº","wyjdz"],
    "czytaj pamiÄ™tnik":["czytaj pamiÄ™tnik","czytaj pamietnik","przeczytaj pamiÄ™tnik","przeczytaj pamietnik","otwÃ³rz pamiÄ™tnik","otworz pamietnik","otwÃ³rz dziennik","otworz dziennik","przeczytaj dziennik"],
    "zejdÅº na dÃ³Å‚":["zejdÅº na dÃ³Å‚","zejdz na dol","zejdÅº","zejdz","idÅº na dÃ³Å‚","idz na dol"],
    "sprawdÅº skrzynkÄ™":["sprawdÅº skrzynkÄ™","sprawdz skrzynke","skrzynka","skrzynki"],
    "nasÅ‚uchuj":["nasÅ‚uchuj","nastaw uszy","sÅ‚uchaj","sluchaj"],
    "uszczypnij siÄ™":["uszczypnij siÄ™","uszczypnij sie","to sen?","czy to sen","czy to byÅ‚ sen","czy to byl sen"],
    "wciÅ›nij przycisk Å›wiatÅ‚a":["wciÅ›nij przycisk Å›wiatÅ‚a","wcisnij przycisk swiatla","wciÅ›nij Å›wiatÅ‚o","wlacz swiatlo","wÅ‚Ä…cz Å›wiatÅ‚o","Å›wiatÅ‚o","swiatlo","przycisk"],
    "sprawdÅº wizjer":["sprawdÅº wizjer","sprawdz wizjer","zajrzyj przez wizjer","zajrzyj w wizjer"],
    "obejrzyj Å›lady":["obejrzyj Å›lady","obejrzyj slady","sprawdÅº Å›lady","sprawdz slady","Å›lady","slady"],
    "sprawdÅº tablicÄ™":["sprawdÅº tablicÄ™","sprawdz tablice","sprawdÅº ogÅ‚oszenia","sprawdz ogloszenia","tablica ogÅ‚oszeÅ„","tablica ogloszen","ogÅ‚oszenia","ogloszenia"],
    "powÄ…chaj powietrze":["powÄ…chaj powietrze","powachaj powietrze","powÄ…chaj","powachaj","wciÄ…gnij powietrze","wciagnij powietrze"],
    "zapukaj do 3":["zapukaj do 3","zapukaj do trujki","zastukaj do 3","pukaj do 3"],
    "otwÃ³rz drzwi na chwilÄ™":["otwÃ³rz drzwi na chwilÄ™","otworz drzwi na chwile","otwÃ³rz drzwi","otworz drzwi"],
    "otwÃ³rz ulotkÄ™":[
      "otwÃ³rz ulotkÄ™","otworz ulotke","uruchom ulotkÄ™","uruchom ulotke",
      "wejdÅº w ulotkÄ™","wejdz w ulotke","interakcja ulotki","zagraj w ulotkÄ™","zagraj w ulotke"
    ]
  };

  function canon(s){
    const t = String(s).trim().toLowerCase();
    for(const [k, forms] of Object.entries(ALIAS)){
      if(forms.includes(t)) return k;
    }
    return t;
  }

  SM.reg("poranek",{
    async enter(){
      await say([
        "Budzi ciÄ™ Å›wiatÅ‚o wciskajÄ…ce siÄ™ przez szczelinÄ™ w zasÅ‚onie. LeÅ¼ysz w swoim Å‚Ã³Å¼ku ubrany w piÅ¼amÄ™. Czy to byÅ‚ tylko sen?",
        "Twoje myÅ›li biegnÄ… jak szalone. Tak... to musiaÅ‚ byÄ‡ tylko sen.... Wtedy dostrzegasz kopertÄ™, ktÃ³rÄ… trzymasz w zaciÅ›niÄ™tej piÄ™Å›ci.",
        "Zrywasz siÄ™ i biegniesz do ubikacji. Ledwo zdÄ…Å¼yÅ‚eÅ›. TargajÄ… tobÄ… torsje, kiedy gwaÅ‚townie wymiotujesz do muszli. Trwa to kilka minut, ale w koÅ„cu nudnoÅ›ci przechodzÄ….",
        "Metaliczny posmak nie chce jednak zniknÄ…Ä‡. Musisz umyÄ‡ zÄ™by. W Å¼oÅ‚Ä…dku burczy â€” jesteÅ› naprawdÄ™ gÅ‚odny."
      ]);
      setCmds(["rozejrzyj siÄ™","umyj zÄ™by","umyj siÄ™","ubierz siÄ™","sprawdÅº lodÃ³wkÄ™","wyjdÅº z mieszkania","pomoc"]);
      G.hungry = true;
    },
    handle(t){
      const c = canon(t);

      if(handleOpenDiary(c)) return true;

      if(ALIAS["rozejrzyj siÄ™"].includes(t)){
        typeText("Mieszkanie wyglÄ…da identycznie jak wczoraj â€” jakby czas naprawdÄ™ siÄ™ zatrzymaÅ‚.");
        consumeCmd("rozejrzyj siÄ™");
        return true;
      }

      // ZMIANA: Dodano odzyskiwanie poczytalnoÅ›ci
      if(c==="umyj siÄ™" && !G.washed){
        G.washed=true;
        const sanGain = Math.floor(Math.random() * 4) + 1;
        if (window.Sanity) Sanity.add(sanGain, "poranek:umyj-sie");
        say([
           "Zimna woda stawia ciÄ™ na nogi. PotrzebowaÅ‚eÅ› tego.",
           `Czujesz, jak zmywa z ciebie czÄ™Å›Ä‡ niepokoju. Odzyskujesz ${sanGain} pkt. poczytalnoÅ›ci.`
        ]);
        consumeCmd("umyj siÄ™");
        return true;
      }

      if(c==="umyj zÄ™by" && !G.brushed){
        G.brushed = true;
        typeText("Szczotkujesz dokÅ‚adnie zÄ™by. Posmak rzygowin znika, a w gÅ‚owie robi siÄ™ jakby jaÅ›niej. Burczenie w brzuchu przypomina, Å¼e przydaÅ‚oby siÄ™ zjeÅ›Ä‡ Å›niadanie.");
        consumeCmd("umyj zÄ™by");
        return true;
      }
      if(c==="ubierz siÄ™" && !G.dressed){
        G.dressed = true;
        typeText("Przebierasz siÄ™ w wczorajsze ubrania. Zarzucasz kurtkÄ™ na ramiona. Zgarniasz portfel z paroma banknotami. Czeka ciÄ™ dziÅ› kilka trudnych decyzji, ale odsuwasz je na potem. JesteÅ› gotÃ³w.");
        Inventory.add("portfel");
        Inventory.add("klucze");
        consumeCmd("ubierz siÄ™");
        return true;
      }
      if(c==="sprawdÅº lodÃ³wkÄ™"){
        if(G.hungry){
          typeText("Otwierasz lodÃ³wkÄ™. Pustka. Nie ma tu nic do jedzenia.");
          typeText("To przesÄ…dza sprawÄ™ â€” bÄ™dziesz musiaÅ‚ pÃ³jÅ›Ä‡ do pobliskiego baru.");
        } else {
          typeText("ZaglÄ…dasz do lodÃ³wki. Nie czujesz gÅ‚odu, ale i tak Å›wieci pustkami.");
        }
        consumeCmd("sprawdÅº lodÃ³wkÄ™");
        return true;
      }

      if(c==="wyjdÅº z mieszkania"){
        if(!G.brushed || !G.dressed){
          typeText(!G.brushed ? "Najpierw musisz umyÄ‡ zÄ™by, a potem siÄ™ przebraÄ‡." : "Jeszcze siÄ™ przebierz, potem wyjdÅº.");
          return true;
        }
        G.leftHome = true;
        consumeCmd("rozejrzyj siÄ™");
        consumeCmd("wyjdÅº z mieszkania");
        SM.go("klatka");
        return true;
      }

      if(["pomoc","?","help"].includes(t)){
        typeText("DostÄ™pne: " + available.join(" / ") + (G.diaryUnlocked ? " / czytaj pamiÄ™tnik" : "") + ".");
        return true;
      }
    }
  });

  SM.reg("klatka",{
    async enter(){
      setCmds([]);
      await say([
        "Zatrzaskujesz za sobÄ… drzwi. Klatka wyglÄ…da normalnie. KtoÅ› umyÅ‚ podÅ‚ogÄ™. Czujesz wyraÅºnie jakiÅ› mocny, chemiczny Å›rodek czyszczÄ…cy.",
        "â€JeÅ›li to byÅ‚ sen... to...â€ â€” nie potrafisz sformuÅ‚owaÄ‡ klarownej myÅ›li. Czujesz, Å¼e coÅ› Ci umyka.",
      ]);
      addCmd("rozejrzyj siÄ™");
    },

    handle(t){
      const c = canon(t);
      
      if(c === "rozejrzyj siÄ™") {
        if(!available.includes("nasÅ‚uchuj")) {
          typeText("Stoisz na pÃ³Å‚piÄ™trze. PodÅ‚oga lÅ›ni czystoÅ›ciÄ…, ale w rogach wciÄ…Å¼ widaÄ‡ stare, ciemne plamy, ktÃ³rych nie daÅ‚o siÄ™ doczyÅ›ciÄ‡. Po lewej stronie jest tablica ogÅ‚oszeÅ„, a obok drzwi do mieszkania numer 3. PoniÅ¼ej, na parterze, widaÄ‡ matowe szkÅ‚o drzwi wejÅ›ciowych.");
          setCmds([
            "nasÅ‚uchuj","uszczypnij siÄ™",
            "sprawdÅº tablicÄ™","powÄ…chaj powietrze",
            "zapukaj do 3",
            "zejdÅº na dÃ³Å‚","pomoc"
          ]);
          addCmd("rozejrzyj siÄ™");
          if (G.board?.read?.sekta) addCmd("otwÃ³rz ulotkÄ™");
        } else {
          typeText("Klatka schodowa wyglÄ…da tak samo. Czysta podÅ‚oga, tablica ogÅ‚oszeÅ„ i drzwi sÄ…siada.");
        }
        consumeCmd("rozejrzyj siÄ™");
        return true;
      }
      if (handleOpenDiary(c)) return true;

      if(!G.g12){
        G.g12 = { talking:false, met:false, rolled:false, rollResult:null, extraGiven:false, askedWeird:false, askedSaw:false };
      }
      if(!G.board){
        G.board = {
          seen:false,
          read:{ remont:false, liczniki:false, sekta:false }
        };
      }
      
      function rollD6(){ return Math.floor(Math.random()*6)+1; }

      if(c==="zapukaj do 3" && !G.g12.talking){
        if(!G.knocked12){
          typeText("Pukasz do drzwi 3. ÅaÅ„cuch po drugiej stronie napina siÄ™ z cichym brzdÄ™kiem. â€Kto tam?â€");
          G.knocked12 = true;
        } else {
          typeText("SÅ‚ychaÄ‡ kroki, Å‚aÅ„cuch drÅ¼y. â€Szybko. Nie mam czasu.â€");
        }
        G.g12.talking = true; 
        G.g12.met = true;

        consumeCmd("zapukaj do 3");
        G.preConversationCmds = available.slice(); 

        say([
          "MÃ³wisz spokojnie: â€DzieÅ„ dobryâ€¦ przepraszam, Å¼e panu przeszkadzam, ale czy nie widziaÅ‚ pan czegoÅ› niezwykÅ‚ego wczorajszej nocy?â€",
          "Za drzwiami chwila ciszy.",
          "â€Z trzynastki? Aha. JuÅ¼ wiem.â€ â€” w gÅ‚osie sÅ‚ychaÄ‡ wyraÅºnÄ… niechÄ™Ä‡.",
          "â€Czego pan chce?â€"
        ], 250);

        setCmds([
          "czy dziaÅ‚o siÄ™ coÅ› niezwykÅ‚ego",
          "co pan widziaÅ‚",
          "do widzenia","pomoc"
        ]);
        
        return true;
      }

      if(G.g12.talking){

        if(c==="czy dziaÅ‚o siÄ™ coÅ› niezwykÅ‚ego"){
          say([
            "â€Nic nie widziaÅ‚em.â€ â€” ton chÅ‚odny.",
            "â€Tylko jakiÅ› chuligan przewrÃ³ciÅ‚ kosz na dole. SprzÄ…taczka rano przyszÅ‚a i sprzÄ…taÅ‚a klatkÄ™.â€"
          ]);
          G.g12.askedWeird = true;
          consumeCmd("czy dziaÅ‚o siÄ™ coÅ› niezwykÅ‚ego");

          if(G.g12.askedWeird && G.g12.askedSaw && !G.g12.rolled){
            addCmd("przekonaj go");
            writeLine("<span class='accent'>Masz wraÅ¼enie, Å¼e da siÄ™ go jeszcze urobiÄ‡ (â€przekonaj goâ€).</span>");
          }
          return true;
        }

        if(c==="co pan widziaÅ‚"){
          say([
            "â€PowiedziaÅ‚em: nic. Kosz zostaÅ‚ przewrÃ³cony, papier siÄ™ walaÅ‚, sprzÄ…taczka ogarnÄ™Å‚a. I tyle.â€"
          ]);
          G.g12.askedSaw = true;
          consumeCmd("co pan widziaÅ‚");

          if(G.g12.askedWeird && G.g12.askedSaw && !G.g12.rolled){
            addCmd("przekonaj go");
            writeLine("<span class='accent'>MoÅ¼esz sprÃ³bowaÄ‡ go przekonaÄ‡ (â€przekonaj goâ€).</span>");
          }
          return true;
        }

        if(c==="przekonaj go"){
          if(!(G.g12.askedWeird && G.g12.askedSaw)){
            typeText("â€Najpierw niech pan powie, o co w ogÃ³le chodzi.â€ â€” brzmi zirytowany. (Zapytaj najpierw o obie rzeczy.)");
            return true;
          }
          if(G.g12.rolled){
            typeText("â€JuÅ¼ wszystko powiedziaÅ‚em.â€"); 
            return true;
          }

          G.g12.rolled = true;
          const r = rollD6();
          G.g12.rollResult = r;
          writeLine(`<i>Rzut k6: ${r}</i>`);

          if(r<=3){
            say([
              "â€Nie bÄ™dÄ™ o tym gadaÅ‚. ProszÄ™ nie dzwoniÄ‡ po ludziach.â€",
              "ÅaÅ„cuch brzÄ™czy. Drzwi zamykajÄ… siÄ™ z hukiem. WyglÄ…da, Å¼e tutaj nic wiÄ™cej siÄ™ nie dowiesz."
            ]);
            if(window.Sanity) Sanity.add(-1, "poranek:sasiad-fail");
          } else {
            G.g12.extraGiven = true;
            say([
              "Chwila milczenia. Potem: â€Dobrze. Ale to tak miÄ™dzy nami.â€",
              "â€KtoÅ› siÄ™ krÄ™ciÅ‚ w nocy na dole. DÅ‚ugi pÅ‚aszcz, nie widziaÅ‚em twarzy. MiaÅ‚ aparat â€” sÅ‚yszaÅ‚em migawkÄ™.â€",
              "â€SprzÄ…taczka z nim chyba gadaÅ‚a. KrÃ³tko, ale rozmawiali.â€"
            ]);
            try{
              localStorage.setItem('cw.articleFragment','Od lokatora z 3: nocÄ… ktoÅ› w dÅ‚ugim pÅ‚aszczu z aparatem, sprzÄ…taczka z nim rozmawiaÅ‚a.');
            }catch(e){}
          }
          consumeCmd("przekonaj go");
          return true;
        }

        if(c==="do widzenia"){
          typeText("â€No. To tyle.â€ â€” Å‚aÅ„cuch wraca na miejsce. Drzwi siÄ™ zamykajÄ….");
          G.g12.talking = false;
          available = G.preConversationCmds || [];
          showHint();
          return true;
        }

        if(["pomoc","?","help"].includes(t)){
          const opts = [];
          if(G.g12.askedWeird && G.g12.askedSaw && !G.g12.rolled) opts.push("przekonaj go");
          opts.push("czy dziaÅ‚o siÄ™ coÅ› niezwykÅ‚ego","co pan widziaÅ‚","do widzenia");
          typeText("Pytania: " + opts.join(" / ") + ".");
          return true;
        }

        typeText("Za drzwiami sÅ‚ychaÄ‡ niecierpliwe cmokniÄ™cie. â€KrÃ³tko i rzeczowo.â€");
        return true;
      }

      if(c==="sprawdÅº tablicÄ™"){
        if(!G.board.seen){
          typeText("Podchodzisz do tablicy. Trzy kartki przybite pinezkami chwiejÄ… siÄ™ od przeciÄ…gu.");
          typeText("1) Remont windy â€” kartka Å›wieÅ¼a, z pieczÄ…tkÄ… administracji.");
          typeText("2) Wymiana licznikÃ³w â€” wydruk ksero, drobny druk.");
          typeText("3) Ulotka â€” KoÅ›ciÃ³Å‚ JednoÅ›ci Cienia: oko w trÃ³jkÄ…cie, czarny tusz i niezrozumiaÅ‚e znaki.");
          G.board.seen = true;
          addCmd("czytaj remont windy");
          addCmd("czytaj wymianÄ™ licznikÃ³w");
          addCmd("czytaj ulotkÄ™");
          if (G.board.read.sekta) addCmd("otwÃ³rz ulotkÄ™");
        } else {
          typeText("Na tablicy: remont windy, wymiana licznikÃ³w i dziwna ulotka z okiem w trÃ³jkÄ…cie.");
          if(!G.board.read.remont)   addCmd("czytaj remont windy");
          if(!G.board.read.liczniki) addCmd("czytaj wymianÄ™ licznikÃ³w");
          if(!G.board.read.sekta)    addCmd("czytaj ulotkÄ™");
          if(G.board.read.sekta)     addCmd("otwÃ³rz ulotkÄ™");
        }
        consumeCmd("sprawdÅº tablicÄ™"); return true;
      }

      if(c==="czytaj remont windy" && G.board.seen && !G.board.read.remont){
        typeText("â€REMONT WINDY â€” Od dnia 14 do 20 bieÅ¼Ä…cego miesiÄ…ca winda bÄ™dzie wyÅ‚Ä…czona z uÅ¼ytku. Prosimy nie blokowaÄ‡ drzwi szybÃ³w i nie uÅ¼ywaÄ‡ przyciskÃ³w na panelach. Za utrudnienia przepraszamy â€” Administracja.â€");
        G.board.read.remont = true; removeCmd("czytaj remont windy"); return true;
      }

      if(c==="czytaj wymianÄ™ licznikÃ³w" && G.board.seen && !G.board.read.liczniki){
        typeText("â€WYMIANA LICZNIKÃ“W â€” W dniach 21â€“23 od godz. 8:00 technicy dokonajÄ… odczytu i wymiany wodomierzy. Prosimy udostÄ™pniÄ‡ mieszkania lub zgÅ‚osiÄ‡ nieobecnoÅ›Ä‡ pod numerem tel. 22 000 00 00.â€");
        G.board.read.liczniki = true; removeCmd("czytaj wymianÄ™ licznikÃ³w"); return true;
      }

      if(c==="czytaj ulotkÄ™" && G.board.seen && !G.board.read.sekta){
        say([
          "â€ÅšWIAT SIÄ˜ KOÅƒCY â€“ TYLKO WYBRANI PRZETRWAJÄ„â€",
          "Czy naprawdÄ™ wierzysz w to, co widzÄ… twoje oczy?",
          "Bratnie dusze ostrzegajÄ…: Å¼yjemy w faÅ‚szu, w matriksie tego zepsutego Å›wiata.",
          "KoÅ›ciÃ³Å‚ JednoÅ›ci Cienia gÅ‚osi: kto nie wyrzeknie siÄ™ doczesnych wiÄ™zÃ³w, zostanie poÅ‚kniÄ™ty przez Mrok Ostateczny.",
          "Nie uciekaj. Tylko wyznanie Prawdy daje ocalenie."
        ], 220).then(()=>{
          if(window.Sanity) Sanity.add(-1, "poranek:ulotka-przeczytana");
        });

        const r = Math.floor(Math.random()*6)+1;
        writeLine(`<i>Rzut k6: ${r}</i>`);
        if(r>=4){
          typeText("Na dole, dopisane innym pismem: â€â€¦peÅ‚zajÄ…cy chaosâ€¦ jestem ostatniâ€¦ opowiem sÅ‚uchajÄ…cej pustceâ€¦â€ â€” H. P. Lovecraft, 1920.");
        }

        const img = document.createElement("img");
        img.src = "ulotka.png";
        img.alt = "Ulotka sekty â€“ pixelart";
        img.style.maxWidth = "320px";
        img.style.margin = "12px 0";
        writeLine(img.outerHTML);

        G.board.read.sekta = true;
        removeCmd("czytaj ulotkÄ™");
        addCmd("otwÃ³rz ulotkÄ™");
        writeLine("<span class='accent'>Ulotka jakby pulsowaÅ‚aâ€¦ moÅ¼esz jÄ… <b>otworzyÄ‡</b> (komenda: â€otwÃ³rz ulotkÄ™â€).</span>");
        try{ localStorage.setItem('cw.articleFragment','Ulotka: KoÅ›ciÃ³Å‚ JednoÅ›ci Cienia, â€PosÅ‚aniec Chaosuâ€, Oko, ostrzeÅ¼enia.'); }catch(e){}
        return true;
      }

      if(c==="nasÅ‚uchuj"){
        if(!G.heardOnce){
          typeText("Wstrzymujesz oddech, wytÄ™Å¼asz sÅ‚uch. Sprzed kamienicy dobiega stÅ‚umiony stukot â€” jakby ktoÅ› przestawiÅ‚ wiadro. MoÅ¼e sprzÄ…taczka coÅ› zauwaÅ¼yÅ‚a?");
          G.heardOnce = true;
        } else { typeText("Nic niezwykÅ‚ego. Miasto budzi siÄ™ do Å¼ycia."); }
        consumeCmd("nasÅ‚uchuj"); return true;
      }

      if(c==="uszczypnij siÄ™"){
        if(!G.pinched){
          typeText("Wolisz siÄ™ upewniÄ‡, czy na pewno nie spisz. Boli. SkÃ³ra szybko czerwienieje. Niestety, wyglÄ…da na to Å¼e to jawa.");
          if(window.Sanity) Sanity.add(-1, "poranek:uszczypniecie");
          G.pinched = true;
        } else { typeText("Powtarzasz test. Ten sam bÃ³l, ta sama smutna rzeczywistoÅ›Ä‡."); }
        consumeCmd("uszczypnij siÄ™"); return true;
      }

      if(c==="powÄ…chaj powietrze"){
        if(!G.sniffed){
          typeText("WciÄ…gasz powietrze nosem. TÅ‚o: wilgoÄ‡ i pyÅ‚. Na drugim planie â€” coÅ› jak metal i przetarty ozon, jak po zwarciu.");
          G.sniffed = true;
        } else { typeText("Zapach bez zmian. Beton, wilgoÄ‡ i ta metaliczna nuta."); }
        consumeCmd("powÄ…chaj powietrze"); return true;
      }

      if(c==="zejdÅº na dÃ³Å‚"){
        typeText("Schodzisz. Z matowego szkÅ‚a parterowych drzwi sÄ…czy siÄ™ mleczne Å›wiatÅ‚o.");
        writeLine("<span class='accent'>MoÅ¼esz przejÅ›Ä‡ dalej.</span>");
        nextBtn.disabled = false;
        consumeCmd("zejdÅº na dÃ³Å‚"); return true;
      }

      if(["pomoc","?","help"].includes(t)){
        const list = available.slice();
        if(G.board?.seen){
          if(!G.board.read.remont)   list.push("czytaj remont windy");
          if(!G.board.read.liczniki) list.push("czytaj wymianÄ™ licznikÃ³w");
          if(!G.board.read.sekta)    list.push("czytaj ulotkÄ™");
          if(G.board.read.sekta)     list.push("otwÃ³rz ulotkÄ™");
        }
        if(G.diaryUnlocked) list.push("czytaj pamiÄ™tnik");
        typeText("DostÄ™pne: " + list.join(" / ") + "."); return true;
      }

      if (handleOpenFlyer(c)) { return true; }

      return false;
    }
  });

  speed.addEventListener('input', () => { speedIdx = +speed.value; speedLabel.textContent = labels[speedIdx]; });
  speedLabel.textContent = labels[speedIdx];
  fastBtn.addEventListener('click', () => { speedIdx = 0; speed.value = 0; speedLabel.textContent = labels[0]; });
  restartBtn.addEventListener('click', () => { window.SAN?.reset?.(100); window.location.reload(); });
  nextBtn.addEventListener('click', () => { window.location.href = NEXT_FILE; });

  function handleInput(){
    const raw = cmd.value.trim();
    if(!raw) return;

    promptEcho(raw);

    const t = raw.toLowerCase();
    const c = canon(t);

    if (["ekwipunek","inwentarz"].includes(t)) {
      const list = (window.Inventory && window.Inventory.list) ? window.Inventory.list() : [];
      if (!list.length) {
        typeText("Ekwipunek jest pusty.");
        cmd.value=""; cmd.focus(); return;
      }
      typeText("Ekwipunek: " + list.join(", "));

      const norm = s => String(s || "").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]+/g,'').trim();
      const inv = list.map(norm);
      const hasDiary = inv.some(x =>
        ["dziennik","stary dziennik","podejrzany dziennik","dziennik (zakrwawiony)",
         "pamietnik","stary pamietnik","podejrzany pamietnik","pamietnik (zakrwawiony)"].includes(x)
      );
      if (hasDiary && !G.diaryUnlocked) { G.diaryUnlocked = true; addCmd("czytaj pamiÄ™tnik"); }
      if (hasDiary) { writeLine("<span class='accent'>PamiÄ™tnik zdaje siÄ™ zmieniaÄ‡â€¦ (â€czytaj pamiÄ™tnikâ€)</span>"); }

      consumeCmd("ekwipunek");
      cmd.value=""; cmd.focus();
      return;
    }

    if (handleOpenDiary(c)) { cmd.value=""; cmd.focus(); return; }
    if (handleOpenFlyer(c)) { cmd.value=""; cmd.focus(); return; }

    const handled = SM.handle(c);
    if(!handled){
      typeText("Nie rozumiem. " + (available.length ? "Komendy: " + available.join(", ") + "." : ""));
    }

    cmd.value=""; cmd.focus();
  }

  send.addEventListener('click', handleInput);
  cmd.addEventListener('keydown', e => { if(e.key==="Enter"){ e.preventDefault(); handleInput(); } });

  SM.go("poranek");
})();
</script>
</body>
</html>