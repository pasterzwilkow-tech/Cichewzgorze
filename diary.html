<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zarażony Dziennik — monoalfabetyczny szyfr + efekt szaleństwa</title>
  <style>
    :root{
      --bg:#0a0e14; --panel:#0f1625; --ink:#e6eef7; --muted:#9bb0c9; --accent:#78e6ff; --err:#ff8a8a; --ok:#8aff9c; --warn:#ffd37a;
      --chip:#162033; --chip-b:#22324d; --hl:#ff4d6d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Ubuntu, Cantarell, Helvetica, Arial; color:var(--ink); background:radial-gradient(1200px 800px at 70% -10%, #1b2a42 0%, transparent 60%), linear-gradient(180deg, var(--bg), #070b10 80%);} 
    .wrap{max-width:1200px; margin:28px auto; padding:0 16px}
    header{display:flex; gap:12px; align-items:baseline; margin-bottom:14px}
    h1{font-size:28px; margin:0}
    .sub{color:var(--muted)}
    .grid{display:grid; grid-template-columns: 1.2fr 1fr; gap:16px}
    .card{background:var(--panel); border:1px solid #1d2740; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:16px}
    .hud{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px}
    .pill{padding:6px 10px; background:var(--chip); border:1px solid var(--chip-b); border-radius:999px; font-size:12px; color:var(--muted)}
    .btn{appearance:none; border:none; border-radius:12px; padding:10px 14px; background:#1b2948; color:#dfe9f7; cursor:pointer; font-weight:600; border:1px solid #2a3964}
    .btn:hover{transform:translateY(-1px); background:#24345a}
    .btn.ghost{background:transparent}
    .btn.warn{background:#3c3110; border-color:#7a5d1a; color:#ffe9b5}
    .btn.ok{background:#0f3d2b; border-color:#1a6b4d; color:#caffe1}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .area{min-height:240px; padding:16px; border-radius:14px; background:#0a1120; border:1px solid #1a2542; line-height:1.8; position:relative; overflow:hidden}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* tekst */
    #cipher, #decoded{white-space:pre-wrap; word-break:break-word}
    .char{display:inline-block; min-width:0.6ch; position:relative}

    /* NIEODKODOWANE (Twoje) */
    .unknown{
      color:#556481;
      border-bottom:1px dotted #556481;
      background:linear-gradient(transparent 72%, rgba(255,77,109,.18) 0);
      border-radius:2px;
      padding:0 1px;
    }

    /* aktywna litera */
    .active{
      background:#1d2b4f; outline:1px solid #2f4376; border-radius:6px;
      transform:scale(1.07);
      box-shadow:0 0 0 3px rgba(45,96,199,.18);
      transition:transform .08s ease;
    }
    .flash{ animation:flash 220ms ease }
    @keyframes flash{ from{box-shadow:0 0 0 6px rgba(120,230,255,.35)} to{box-shadow:0 0 0 0 rgba(120,230,255,0)} }

    /* NIEODKODOWANE w szyfrogramie (brak przypisania) */
    .undecoded{
      color:#6b7a94;
      background:repeating-linear-gradient(-45deg, rgba(120,230,255,.08) 0 4px, rgba(0,0,0,0) 4px 8px);
      border-radius:4px; padding:0 1px;
    }

    /* glitch / infection visuals */
    @keyframes jitter { 0%{transform:translate(0,0)} 25%{transform:translate(0.4px,-0.3px)} 50%{transform:translate(-0.3px,0.4px)} 75%{transform:translate(0.3px,0.2px)} 100%{transform:translate(0,0)} }
    @keyframes bleed { 0%{ filter: none } 50%{ filter: contrast(1.08) saturate(1.1) } 100%{ filter: none } }
    .infected .char{ animation: jitter 0.7s infinite linear; text-shadow: 0 0 0 rgba(0,0,0,0.0); }
    .infected.heavy .char{ text-shadow: 1px 0 var(--hl), -1px 0 #5df, 0 0 6px #000; }
    .bleed{ animation: bleed 2.2s infinite ease-in-out }

    .gbar{height:8px; width:100%; background:#0b1222; border:1px solid #1a2542; border-radius:999px; overflow:hidden}
    .gbar > div{height:100%; background:linear-gradient(90deg, #ff4d6d, #ffe066); width:0%}

    .mapgrid{display:grid; grid-template-columns:repeat(13,1fr); gap:6px}
    .cell{background:#0d1529; border:1px solid #1e2a4a; border-radius:10px; padding:8px; text-align:center}
    .cell .lab{display:block; font-size:12px; color:#8ea3bd}
    .cell input{width:100%; text-align:center; margin-top:6px; padding:6px 4px; border-radius:8px; border:1px solid #26365f; background:#0a1120; color:#e7f0ff}

    .freq{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
    .bar{background:#101a31; border:1px solid #223052; border-radius:6px; padding:6px 8px; font-size:12px}

    .footer{margin-top:18px; font-size:12px; color:#97a9bf}

    /* success overlay */
    .overlay{position:absolute; inset:0; display:none; place-items:center; backdrop-filter: blur(1.5px)}
    .overlay.show{display:grid}
    .overlay .box{background:rgba(10,17,32,.92); border:1px solid #2a3a63; border-radius:16px; padding:20px; text-align:center; width:min(520px,90%)}

    /* toast */
    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
      background:#0f3d2b; border:1px solid #1a6b4d; color:#caffe1;
      padding:10px 14px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.35);
      z-index:9999; opacity:0; transition:opacity .2s ease, transform .2s ease}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}

    /* insanity */
    .insanity{ animation: sceneFlicker 0.12s infinite steps(2); }
    @keyframes sceneFlicker{ from{ filter:contrast(1) } to{ filter:contrast(1.25) hue-rotate(8deg) } }

    /* image flash */
    .image-flash{ position:fixed; inset:0; display:grid; place-items:center; pointer-events:none; z-index:9999; opacity:0; transition:opacity 220ms ease;}
    .image-flash.show{ opacity:1; }
    .image-flash img{ max-width:min(70vw, 900px); max-height:75vh; border-radius:14px; border:1px solid #2a3a63; box-shadow:0 30px 90px rgba(0,0,0,.65); filter:contrast(1.06) saturate(1.05); animation:flashGlint 1s ease-in-out;}
    @keyframes flashGlint{ from{ filter:brightness(1.1) contrast(1.15) } to{ filter:brightness(1.0) contrast(1.06) } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Zarażony Dziennik</h1>
      <div class="sub">Szyfr monoalfabetyczny + stopniowe „zarażanie” tekstu i efekt szaleństwa. Brak polskich znaków.</div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="hud">
          <div class="pill">Postęp: <span id="progress">0%</span></div>
          <div class="pill">Zarażenie: <span id="infectPct">0%</span></div>
          <div class="pill">Aktywna litera: <span id="activeLab">—</span></div>
          <div class="row" style="margin-left:auto">
            <button class="btn ghost" id="btnHint">Podpowiedź</button>
            <button class="btn" id="btnNewKey">Nowy szyfr</button>
            <button class="btn warn" id="btnReset">Wyczyść mapowanie</button>
          </div>
        </div>

        <div class="gbar" title="Zarażenie rośnie z czasem i postępem">
          <div id="infectBar"></div>
        </div>

        <label style="display:block;margin:12px 0 6px;color:var(--muted)">Szyfrogram</label>
        <div id="cipher" class="area mono"></div>

        <label style="display:block;margin:12px 0 6px;color:var(--muted)">Odszyfrowanie (Twoje)</label>
        <div id="decoded" class="area mono"></div>
        <div id="overlay" class="overlay">
          <div class="box">
            <h3>Odszyfrowano</h3>
            <p>Wszystko wygląda na sensowne… ale czemu litery zaczynają się ruszać?</p>
            <button class="btn ok" id="btnContinueMadness">Kontynuuj</button>
          </div>
        </div>

        <div class="freq" id="freq"></div>
      </section>

      <aside class="card">
        <h3 style="margin:4px 0 10px">Mapa liter (cipher → plain)</h3>
        <div class="mapgrid" id="mapgrid"></div>
        <p class="sub" style="margin-top:10px">Kliknij dowolną literę w tekście, a potem naciśnij klawisz, by przypisać. <br/>Wpisz <b>Backspace</b>, by wyczyścić.</p>
      </aside>
    </div>

    <div class="footer">Kamil Radoń — mechanika: monoalfabetyczny szyfr + postępujące zarażenie (glitch/jitter/bleed). Tekst bazuje na „Dzienniku szaleństwa” (bez polskich znaków na potrzeby szyfru).</div>
  </div>

  <!-- PODPIĘTY EKWIPUNEK -->
  <script src="inventory.js"></script>

  <script>
    // ===== Utilities =====
    const A = 'A'.charCodeAt(0); const Z='Z'.charCodeAt(0);
    const isAZ = c => { const x=c.charCodeAt(0); return x>=A && x<=Z };
    const letters = Array.from({length:26}, (_,i)=> String.fromCharCode(A+i));
    const strip = s => s.normalize('NFD').replace(/\p{M}+/gu,'').replace(/ß/g,'ss').replace(/ł/gi,'l');
    const normUP = s => strip(s).toUpperCase();
    const REWARD_ITEM = 'biała wstążka';

    function shuffle(arr){ const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

    // ===== Tekst dziennika =====
const RAW = `Dzien 1
Jeszcze wszystko wydaje sie normalne. Pracuje, ale cos nie daje mi spokoju.
Kazdy dzwiek jest zbyt glosny, kazdy cien zdaje sie poruszac.
Powtarzam sobie, ze to tylko zmeczenie.

Dzien 5
Glosy w mojej glowie szepcza, kiedy gasze swiatlo.
Mowia, zebym pisal dalej. Palce bola, ale nie moge sie zatrzymac.
Czasem wydaje mi sie, ze widze kontury nieludzkich ksztaltow w mroku.

Dzien 12
Slowa ukladaja sie w ostrzezenia.
Tone coraz glebiej, jakbym schodzil po schodach w nieskonczona otchlan.
"Nie powinnismy patrzec poza zaslone snu" — szept powraca w kazdym zdaniu.

Dzien 20
Nie wiem, czy pisze, czy to ktos mna pisze.
Czuje obecnosc. Za plecami zawsze cos stoi.Przestaje odrozniac prawde od urojonych obrazow.
Jak u Lovecrafta — "czlowiek byl nieznaczny, lecz bezdenna groza wszechswiata pochylila sie nad nim".

Dzien 30
Stracilem rachube czasu. Dziennik staje sie pulapka.
Kazde slowo to krzyk o pomoc. 
Jesli to czytasz... moze juz mnie nie ma.`;

    const PLAIN = normUP(RAW);

    // ===== Substitution key =====
    let encMap = {}; // plain->cipher
    let decMap = {}; // cipher->plain (true)
    let userMap = {}; // cipher->plain (user)

    function newKey(){
      const perm = shuffle(letters);
      encMap = {}; decMap = {}; userMap = {};
      for(let i=0;i<26;i++){ const p=letters[i]; const c=perm[i]; encMap[p]=c; decMap[c]=p; userMap[c]=''; }
    }

    function encode(plain){
      let out='';
      for(const ch of plain){ out += isAZ(ch)? encMap[ch] : ch; }
      return out;
    }

    // ===== DOM =====
    const elCipher = document.getElementById('cipher');
    const elDecoded = document.getElementById('decoded');
    const elMapgrid = document.getElementById('mapgrid');
    const elFreq = document.getElementById('freq');
    const elProgress = document.getElementById('progress');
    const elInfectPct = document.getElementById('infectPct');
    const elInfectBar = document.getElementById('infectBar');
    const elActiveLab = document.getElementById('activeLab');
    const elOverlay = document.getElementById('overlay');

    const elBtnHint = document.getElementById('btnHint');
    const elBtnNewKey = document.getElementById('btnNewKey');
    const elBtnReset = document.getElementById('btnReset');

    let CIPHER = ''; // generated

    // ===== MAPA LITER (UI) =====
    function buildMap(){
      elMapgrid.innerHTML = letters.map(c=>{
        return `<div class="cell"><span class="lab">${c} →</span><input data-c="${c}" maxlength="1" placeholder="—" /></div>`;
      }).join('');
      elMapgrid.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('input', (e)=>{
          const c = e.target.dataset.c; // cipher letter
          const val = (e.target.value||'').toUpperCase().replace(/[^A-Z]/g,'');
          // unikalność plain: jeśli już gdzieś wpisano tę samą literę – wyczyść tamtą
          if(val){
            elMapgrid.querySelectorAll('input').forEach(x=>{ if(x!==e.target && x.value.toUpperCase()===val) x.value=''; });
            userMap[c]=val;
          } else { userMap[c]=''; }
          renderDecoded();
          updateActiveLabel();
          flashCipher(c);
          refreshCipherClasses();
        });
        inp.addEventListener('focus', ()=>{ setActiveCipher(inp.dataset.c); });
      });
    }

    // ===== AKTYWNA LITERA (oba pola + HUD) =====
    let activeC='';
    function setActiveCipher(c){
      activeC=c;
      updateActiveLabel();
      highlightActive();
    }
    function updateActiveLabel(){
      if(!activeC){ elActiveLab.textContent='—'; return; }
      const m = userMap[activeC] || '—';
      elActiveLab.textContent = `${activeC} → ${m}`;
    }

    function highlightActive(){
      elDecodedSpans.forEach(s=> s.classList.toggle('active', activeC && s.dataset.c===activeC));
      elCipherSpans.forEach(s=> s.classList.toggle('active', activeC && s.dataset.c===activeC));
    }

    function flashCipher(c){
      elCipherSpans.forEach(s=>{
        if(s.dataset.c===c){ s.classList.add('flash'); setTimeout(()=>s.classList.remove('flash'), 240); }
      });
    }

    // ===== RENDER: szyfr i odszyfr =====
    let elDecodedSpans=[]; let elCipherSpans=[];

    function refreshCipherClasses(){
      if(!elCipherSpans) return;
      elCipherSpans.forEach(s=>{
        const c = s.dataset.c;
        const undec = isAZ(c) && !userMap[c];
        s.classList.toggle('undecoded', undec);
      });
    }

    function renderCipher(){
      elCipher.innerHTML = '';
      const frag = document.createDocumentFragment();
      for(let i=0;i<CIPHER.length;i++){
        const ch=CIPHER[i];
        const s=document.createElement('span'); s.className='char'; s.dataset.c = ch; s.textContent = ch;
        s.addEventListener('click', ()=>{
          if(isAZ(ch)){
            setActiveCipher(ch);
            const target=elMapgrid.querySelector(`input[data-c="${ch}"]`);
            target?.focus();
          }
        });
        frag.appendChild(s);
      }
      elCipher.appendChild(frag);
      elCipherSpans = Array.from(elCipher.querySelectorAll('.char'));
      refreshCipherClasses();
      highlightActive();
    }

    function freqCount(txt){ const m=new Map(); for(const ch of txt){ if(isAZ(ch)) m.set(ch,(m.get(ch)||0)+1); } return [...m.entries()].sort((a,b)=> b[1]-a[1]); }

    function renderFreq(){
      const top = freqCount(CIPHER).slice(0,10);
      elFreq.innerHTML = top.map(([ch,n])=> `<div class="bar">${ch}: ${n}</div>`).join('');
    }

    function progressPct(){
      let known=0, total=0; 
      for(const ch of CIPHER){ if(isAZ(ch)){ total++; if(userMap[ch]) known++; } }
      return total? Math.round(100*known/total):0;
    }

    function renderDecoded(){
      elDecoded.innerHTML='';
      const frag=document.createDocumentFragment();
      for(let i=0;i<CIPHER.length;i++){
        const c=CIPHER[i];
        const span=document.createElement('span'); span.className='char'; span.dataset.c=c;
        if(isAZ(c)){
          const guess=userMap[c];
          if(guess){ span.textContent = guess; span.dataset.real=guess; }
          else { span.textContent = '•'; span.classList.add('unknown'); span.dataset.real='•'; }
        } else { span.textContent = c; span.dataset.real=c; }
        frag.appendChild(span);
      }
      elDecoded.appendChild(frag);
      elDecodedSpans = Array.from(elDecoded.querySelectorAll('.char'));
      highlightActive();
      refreshCipherClasses();

      const pct = progressPct();
      elProgress.textContent = pct + '%';

      // Sprawdź pełne trafienie
      const attempt = Array.from(elDecodedSpans).map(s=> s.dataset.c && isAZ(s.dataset.c) ? (userMap[s.dataset.c]||'•') : s.textContent).join('');
      if(attempt === PLAIN){ onSolved(); }
    }

    // ===== INFECT MECHANICS (spowolnione) =====
    let startTs=Date.now();
    let infection=0; // 0..1
    let solved=false;

    function updateInfection(){
      if(solved) return;
      const elapsed = (Date.now()-startTs)/1000; // s
      const base = Math.max(0, (elapsed-40)/120);   // start po ~40s, pełne po ~160s
      const prog = (progressPct()/100) * 0.35;      // wpływ postępu słabszy
      infection = Math.min(1, base + prog);
      applyInfectionVisuals();
    }

    function applyInfectionVisuals(){
      elInfectPct.textContent = Math.round(infection*100)+'%';
      elInfectBar.style.width = (infection*100)+'%';
      elDecoded.classList.toggle('infected', infection>0.28);
      elDecoded.classList.toggle('heavy',    infection>0.72);
      elDecoded.classList.toggle('bleed',    infection>0.85);
    }

    function scrambleOnce(intensity=0.12, duration=150){
      if(!elDecodedSpans || elDecodedSpans.length===0) return;
      const lettersOnly = elDecodedSpans.filter(s=> isAZ(s.dataset.c));
      const k = Math.max(1, Math.floor(lettersOnly.length * intensity));
      for(let i=0;i<k;i++){
        const s = lettersOnly[Math.floor(Math.random()*lettersOnly.length)];
        const original = s.dataset.real;
        const rnd = letters[Math.floor(Math.random()*26)];
        s.textContent = rnd;
        setTimeout(()=>{ s.textContent = original; }, duration + Math.floor(Math.random()*140));
      }
    }

    // rzadziej i łagodniej
    setInterval(()=>{
      updateInfection();
      if(infection>0.35) scrambleOnce(0.01 + infection*0.04, 130);
    }, 900);

    // ===== Flash grafiki podczas „szaleństwa” =====
    const FLASH_IMG_SRC = 'szaleństwo.png'; // ten sam folder
    const __pre = new Image(); __pre.src = FLASH_IMG_SRC;

    function flashImage(src=FLASH_IMG_SRC, duration=3000){
      const wrap = document.createElement('div');
      wrap.className = 'image-flash';
      wrap.setAttribute('aria-hidden','true');

      const img = document.createElement('img');
      img.src = src; img.alt = '';
      wrap.appendChild(img);

      document.body.appendChild(wrap);
      requestAnimationFrame(()=> wrap.classList.add('show'));
      setTimeout(()=>{
        wrap.classList.remove('show');
        setTimeout(()=> wrap.remove(), 260);
      }, duration);
    }

    // ===== pomocnicze: toast + nagroda ekwipunku =====
    function showToast(msg){
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      requestAnimationFrame(()=> t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(), 250); }, 2200);
    }

    function giveInventoryReward(){
      const inv = window.Inventory;
      const name = REWARD_ITEM;
      try{
        if (inv && typeof inv.has === 'function' && typeof inv.add === 'function') {
          if (!inv.has(name)) {
            inv.add(name);
            showToast(`Dodano do ekwipunku: ${name}`);
          } else {
            showToast(`Już masz: ${name}`);
          }
        } else {
          // fallback do localStorage (zgodny z inventory.js – ten sam klucz)
          const key = "cw.inventory.v1";
          const arr = JSON.parse(localStorage.getItem(key) || "[]");
          if(!arr.includes(name)) {
            arr.push(name);
            localStorage.setItem(key, JSON.stringify(arr));
            showToast(`Dodano do ekwipunku: ${name}`);
          } else {
            showToast(`Już masz: ${name}`);
          }
        }
      }catch(e){
        console.error(e);
        showToast(`(Błąd zapisu nagrody)`);
      }
    }

    // ===== Solve & madness =====
    function onSolved(){
      if(solved) return; solved=true;
      elMapgrid.querySelectorAll('input').forEach(i=> i.disabled=true);

      // NAGRODA: jeśli rozwiązano zanim zarażenie osiągnie 100%
      if(infection < 1){
        giveInventoryReward();
      }

      document.getElementById('overlay').classList.add('show');
    }

    document.getElementById('btnContinueMadness')?.addEventListener('click', ()=>{
      document.getElementById('overlay').classList.remove('show');

      const stage = ()=>{
        document.body.classList.add('insanity');

        // 3-sekundowy flash grafiki „szaleństwo.png”
        flashImage(FLASH_IMG_SRC, 3000);

        let t=0;
        const burst = setInterval(()=>{
          scrambleOnce(0.25, 220);
          t++;
          if(t>24){
            clearInterval(burst);
            revealTrue();
          }
        }, 120);
      };

      stage();
    });

    function revealTrue(){
      const msg = `PRAWDA:
To nie szyfr byl problemem. To ja. To my. Rzeczywistosc peka. Tylko udaje ze da sie ja poukladac. Smierc jest laskawa, albowiem nie ma od niej odwrotu, jednakze ten, kto wraca z najglebszych komnat nocy, strudzony i swiadom, nigdy juz nie zazna spokoju.`;
      const box = document.createElement('div');
      box.style.position='absolute'; box.style.inset='0'; box.style.display='grid'; box.style.placeItems='center'; box.style.pointerEvents='none';
      const inner = document.createElement('div'); inner.className='area mono'; inner.style.background='rgba(10,17,32,.92)'; inner.style.border='1px solid #2a3a63'; inner.style.maxWidth='720px'; inner.style.textAlign='left'; inner.style.lineHeight='1.8'; inner.style.opacity='0'; inner.style.transition='opacity 1400ms ease'; inner.textContent=msg;
      box.appendChild(inner); elDecoded.appendChild(box);
      requestAnimationFrame(()=>{ inner.style.opacity='1'; });
    }

    // ===== Buttons =====
    document.getElementById('btnHint').addEventListener('click', ()=>{
      const top = freqCount(CIPHER)[0]?.[0];
      if(!top) return;
      alert(`Najczestsza litera szyfrogramu to ${top}. W jezyku polskim czesto dominuja E lub A. Sprobuj przypisac ${top}→E lub ${top}→A.`);
    });

    document.getElementById('btnNewKey').addEventListener('click', ()=>{
      newKey(); CIPHER = encode(PLAIN);
      buildMap(); renderCipher(); renderFreq(); renderDecoded();
      startTs=Date.now(); infection=0; applyInfectionVisuals();
      setActiveCipher(''); // czyść HUD
      refreshCipherClasses();
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      userMap = Object.fromEntries(letters.map(c=> [c,'']));
      elMapgrid.querySelectorAll('input').forEach(i=> i.value='');
      renderDecoded(); updateActiveLabel();
      refreshCipherClasses();
    });

    // ===== Keyboard mapping =====
    window.addEventListener('keydown', (e)=>{
      const key = e.key.toUpperCase();
      if(activeC && /^[A-Z]$/.test(key)){
        const target = elMapgrid.querySelector(`input[data-c="${activeC}"]`);
        if(target){
          // unikalność
          elMapgrid.querySelectorAll('input').forEach(x=>{ if(x!==target && x.value.toUpperCase()===key) x.value=''; });
          target.value = key; userMap[activeC]=key;
          renderDecoded(); updateActiveLabel(); flashCipher(activeC);
          refreshCipherClasses();
        }
      } else if(activeC && (e.key==='Backspace' || e.key==='Delete')){
        const target = elMapgrid.querySelector(`input[data-c="${activeC}"]`);
        if(target){ target.value=''; userMap[activeC]=''; renderDecoded(); updateActiveLabel(); refreshCipherClasses(); }
        e.preventDefault();
      }
    });

    // ===== Init =====
    function init(){
      newKey(); CIPHER = encode(PLAIN);
      buildMap(); renderCipher(); renderFreq(); renderDecoded();
      startTs=Date.now(); infection=0; applyInfectionVisuals();
    }
    init();
  </script>
</body>
</html>
