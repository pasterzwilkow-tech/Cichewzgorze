<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ciche Wzgórze — Pościg</title>
<style>
  :root{ --bg:#07090c; --fg:#e6e6e6; --muted:#9aa0a6; --accent:#c7a26d; --panel:rgba(255,255,255,.04); --line:rgba(255,255,255,.08); }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:radial-gradient(1200px 800px at 70% -10%, #11161e 0%, #07090c 60%, #05070a 100%); color:var(--fg); font:16px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Ubuntu,Cantarell}
  .wrap{max-width:920px; margin:0 auto; padding:24px 16px 120px}
  .art{display:block; max-width:720px; width:100%; margin:8px auto 12px;
        border-radius:10px; border:1px solid var(--line); background:rgba(0,0,0,.25)}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px}
  h1{font-size:20px; margin:0; letter-spacing:.02em; color:#f1f1f1}
  .pill{display:inline-flex; gap:6px; align-items:center; padding:.25em .6em; border:1px solid rgba(255,255,255,.12); border-radius:999px; font-size:12px; color:#cbd5e1; margin-right:0}
  .pill strong{color:#fff; font-weight:700}
  .panel{background:var(--panel); border:1px solid var(--line); border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,.35); display:flex; flex-direction:column;}
  #log{height:60vh; min-height:340px; overflow:auto; padding:18px 18px 6px; scrollbar-width:thin}
  #log::-webkit-scrollbar{height:8px; width:8px}
  #log::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1); border-radius:20px}
  .line{margin:0 0 14px; opacity:.96}
  .type{border-right:2px solid rgba(255,255,255,.65); animation:caret .85s steps(1) infinite}
  @keyframes caret{50%{border-color:transparent}}
  .toolbar{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:14px; padding:10px 12px; border-top:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02))}
  input[type=range]{accent-color:#b5c4ff}
  button{padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:rgba(255,255,255,.06); color:var(--fg); cursor:pointer}
  button:hover{background:rgba(255,255,255,.1)}
  .sep{opacity:.35; margin:0 .25em}
  #inputbar{display:flex; gap:10px; padding:10px; border-top:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02))}
  #cmd{flex:1; padding:12px 14px; border-radius:10px; border:1px solid var(--line); background:rgba(3,6,9,.6); color:var(--fg); outline:none}
  #cmd::placeholder{color:#8892a6}
  .note{color:var(--muted); font-size:13px; margin-top:8px}
  .accent{color:var(--accent)}

  /* === SANITY FX (CSS) === */
  #sanFx{position:fixed; inset:0; pointer-events:none; z-index:50}
  #sanFx .vig{position:absolute; inset:-10%; background:
    radial-gradient(70% 70% at 50% 50%, transparent 45%, rgba(0,0,0,.65) 100%);
    opacity:0; transition:opacity .35s ease}
  #sanFx .scan{position:absolute; inset:0;
    background:repeating-linear-gradient(to bottom, rgba(255,255,255,.035) 0 2px, rgba(0,0,0,0) 2px 4px);
    mix-blend-mode:overlay; opacity:0; transition:opacity .35s ease}

  body.san-t2 .panel{filter:saturate(.9) contrast(1.03)}
  body.san-t3 .panel{filter:hue-rotate(-6deg) saturate(.85) contrast(1.06)}
  body.san-t4 .panel{filter:hue-rotate(-12deg) saturate(.75) contrast(1.1) blur(.3px)}
  body.san-t5 .panel{filter:hue-rotate(-18deg) saturate(.6) contrast(1.18) blur(.6px)}
  body.san-t3 #sanFx .vig{opacity:.28}
  body.san-t4 #sanFx .vig{opacity:.5}
  body.san-t5 #sanFx .vig{opacity:.72}
  body.san-t4 #sanFx .scan{opacity:.15}
  body.san-t5 #sanFx .scan{opacity:.28}

  @keyframes sanJitter { 0%,97%,100%{transform:translate3d(0,0,0)} 98%{transform:translate3d(.6px,-.6px,0)} 99%{transform:translate3d(-.7px,.5px,0)} }
  body.san-t4 .panel, body.san-t5 .panel { animation:sanJitter 7.5s infinite }

  body.san-t5 #log .line{ text-shadow:1px 0 rgba(255,0,0,.28), -1px 0 rgba(0,255,255,.22); }
</style>
</head>
<body>
  <div id="sanFx" aria-hidden="true">
    <div class="vig"></div>
    <div class="scan"></div>
  </div>

  <div class="wrap">
    <header>
      <h1>Ciche Wzgórze — Pościg</h1>
      <div>
      <span class="pill" id="sanBadge" title="Poczytalność (SAN)"><strong>SAN</strong>&nbsp;<span id="sanVal">—</span></span>
      </div>
    </header>

    <section class="panel">
      <div id="log" aria-live="polite"></div>
      <div class="toolbar">
        <button id="fast">Przyspiesz</button>
        <span class="sep">|</span>
        <span>Tempo</span>
        <input type="range" id="speed" min="0" max="3" step="1" value="3" />
        <span id="speedLabel">powoli</span>
        <span class="sep">|</span>
        <button id="continue" disabled>Przejdź dalej</button>
        <span class="sep">|</span>
        <button id="restart">Restart</button>
      </div>
      <div id="inputbar">
        <input id="cmd" autocomplete="off" spellcheck="false" placeholder="wpisz komendę…" />
        <button id="send">Wyślij</button>
      </div>
    </section>
    <p class="note" id="hint" style="display:none"></p>
  </div>

  <script src="sanity.js"></script>
  <script>
  /* === SAN PERSIST (localStorage) === */
  (() => {
    const SAN_KEY = "cw.san.v1";
    const clamp = v => Math.max(0, Math.min(100, v|0));
    const loadSAN = () => {
      const raw = localStorage.getItem(SAN_KEY);
      const n = +raw;
      return Number.isFinite(n) ? clamp(n) : 100;
    };
    const saveSAN = v => { try{ localStorage.setItem(SAN_KEY, String(clamp(v))); }catch(e){} };

    window.SAN = {
      key: SAN_KEY,
      load: loadSAN,
      save: saveSAN,
      reset(v=100){ try{ localStorage.removeItem(SAN_KEY); }catch(e){}; saveSAN(v); if (window.Sanity?.set) Sanity.set(v); }
    };

    window.addEventListener("storage", (e) => {
      if (e.key === SAN_KEY && e.newValue != null && window.Sanity?.set) {
        const next = clamp(+e.newValue);
        if (Number.isFinite(next) && window.Sanity?.get && Sanity.get() !== next) {
          Sanity.set(next);
        }
      }
    });
  })();
  </script>
  <script src="inventory.js"></script>

  <script>
  (() => {
    const NEXT_FILE = "car.html"; // <- zmień, jeśli kolejny plik ma inną nazwę

    /* ===== DOM, UI ===== */
    const SPEEDS = [0, 2, 10, 60];
    let speedIdx = 3;
    const labels = ["natychmiast","szybko","standard","powoli"];

    const log = document.getElementById('log');
    const speed = document.getElementById('speed');
    const speedLabel = document.getElementById('speedLabel');
    const fastBtn = document.getElementById('fast');
    const restartBtn = document.getElementById('restart');
    const continueBtn = document.getElementById('continue');
    const cmd = document.getElementById('cmd');
    const send = document.getElementById('send');
    const hint = document.getElementById('hint');

    function scrollBottom(){ log.scrollTop = log.scrollHeight; }
    function writeLine(html){
      const d = document.createElement('div');
      d.className = 'line';
      d.innerHTML = html;
      log.appendChild(d);
      scrollBottom();
      return d;
    }
    let queue = Promise.resolve();
    let sanTypeFactor = 1; // for type speed
    function typeText(text){
      queue = queue.then(async () => {
        const d = writeLine("");
        const s = document.createElement('span');
        s.className = "type";
        d.appendChild(s);
        const ms = Math.max(0, Math.round(SPEEDS[speedIdx] * sanTypeFactor));
        const str = String(text ?? "");
        if(ms<=0){ s.textContent = str; s.classList.remove('type'); return; }
        for(const ch of str){
          s.textContent += ch;
          await new Promise(r => setTimeout(r, ms));
          scrollBottom();
        }
        s.classList.remove('type');
      });
      return queue;
    }
    async function say(lines, gap=350){
      for(const l of lines){ await typeText(l); if(gap) await new Promise(r=>setTimeout(r,gap)); }
    }
    const escapeHtml = s => String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
    function promptEcho(t){ writeLine("&gt; " + escapeHtml(t)); }

    /* ===== SANITY bootstrap ===== */
    const sanValEl = document.getElementById("sanVal");
    let sanWhisperTimer = null;
    let sanScrambleTimer = null;

    function tierFor(v){ return v>=80?1 : v>=60?2 : v>=40?3 : v>=20?4 : 5; }
    function applySanityTier(t){
      document.body.classList.remove('san-t1','san-t2','san-t3','san-t4','san-t5');
      document.body.classList.add('san-t'+t);
      sanTypeFactor = [1.0, 0.95, 0.9, 0.85, 0.8][t-1] || 1;

      if (sanWhisperTimer) { clearInterval(sanWhisperTimer); sanWhisperTimer = null; }
      if (t >= 4) {
        sanWhisperTimer = setInterval(()=>{
          if (Math.random() < 0.35) {
            const pool = ["…to nie ona…","…nie odwracaj się…","…słyszysz?…","…nie jesteś sam…","…znowu patrzą…"];
            writeLine(`<span style="color:#aeb4bd;font-style:italic;opacity:.8">${pool[Math.floor(Math.random()*pool.length)]}</span>`);
          }
        }, 9000);
      }

      if (sanScrambleTimer) { clearInterval(sanScrambleTimer); sanScrambleTimer = null; }
      if (t === 5) {
        sanScrambleTimer = setInterval(()=> scrambleLogOnce(0.10, 160), 900);
      }
    }

    function scrambleLogOnce(intensity=0.10, duration=150){
      const spans = log?.querySelectorAll('.line span, .line') || [];
      if (!spans.length) return;
      const target = spans[Math.floor(Math.random()*spans.length)];
      const original = target.textContent;
      if (!original || original.length < 2) return;
      const idx = Math.max(1, Math.floor(original.length * intensity));
      let chars = original.split('');
      for (let i = 0; i < idx; i++) {
        const p = Math.floor(Math.random() * chars.length);
        if (!/\s/.test(chars[p])) {
          const code = chars[p].codePointAt(0);
          chars[p] = String.fromCodePoint(code + 1);
        }
      }
      target.textContent = chars.join('');
      setTimeout(() => { target.textContent = original; }, duration + Math.floor(Math.random()*120));
    }

    function syncSan(v){
      if (sanValEl) sanValEl.textContent = `${v}/100`;
      applySanityTier(tierFor(v));
    }

    if (window.Sanity && typeof Sanity.init === "function") {
      const _startSAN = (window.SAN?.load ? window.SAN.load() : 100);
      Sanity.init({ start: _startSAN, mount: ".toolbar" });
      const _onSanChange = (v)=>{ try{ window.SAN?.save?.(v); }catch(e){}; syncSan(v); };
      if (typeof Sanity.subscribe === "function")      Sanity.subscribe(_onSanChange);
      else if (typeof Sanity.onChange === "function")  Sanity.onChange(_onSanChange);
      syncSan(Sanity.get?.() ?? _startSAN);
    } else {
      syncSan(window.SAN?.load?.() ?? 100);
    }

    // Optional glitch wrapper if available
    if (window.Sanity && typeof Sanity.wrapTypeText === "function") {
      const _origType = typeText;
      typeText = (txt)=> (Sanity.get && Sanity.get()<20 ? Sanity.wrapTypeText(_origType)(txt) : _origType(txt));
    }

    /* ===== Hints / Commands ===== */
    let available = [];
    function setCmds(arr){ available = arr.slice(); if(!available.includes("ekwipunek")) available.push("ekwipunek"); showHint(); }
    function addCmd(c){ if(!available.includes(c)){ available.push(c); if(!available.includes("ekwipunek")) available.push("ekwipunek"); showHint(); } }
    function removeCmd(c){ const i = available.indexOf(c); if(i>-1){ available.splice(i,1); showHint(); } }
    function showHint(){
      hint.style.display = "block";
      hint.innerHTML = "Komendy: " + (available.length ? available.map(c=>"<b>"+escapeHtml(c)+"</b>").join(", ") : "—") + ".";
    }

    function showContinue(url = NEXT_FILE, label = "Przejdź dalej"){
      continueBtn.textContent = label;
      continueBtn.disabled = false;
      continueBtn.onclick = () => { window.location.href = url; };
      if (!available.includes("przejdź dalej")) addCmd("przejdź dalej");
      if (!available.includes("dalej")) addCmd("dalej");
    }

    /* ===== Scene Manager ===== */
    const SM = {
      current:null, scenes:{},
      reg(name, obj){ this.scenes[name] = obj; },
      async go(name){
        if(this.current && this.scenes[this.current]?.exit){ this.scenes[this.current].exit(); }
        this.current = name;
        if(this.scenes[name]?.enter){ await this.scenes[name].enter(); }
      },
      handle(t){
        const S = this.scenes[this.current];
        if(!S || !S.handle) return false;
        return !!S.handle(t);
      }
    };

    /* ===== Input handling ===== */
    function handleInput(){
      const t = cmd.value.trim().toLowerCase();
      if(!t) return;
      promptEcho(t);

      if (["przejdź dalej","dalej","idź dalej","idz dalej","naprzód","naprzod"].includes(t)){
        if (!continueBtn.disabled) { continueBtn.click(); cmd.value=""; cmd.focus(); return; }
      }

      if (["ekwipunek","inwentarz"].includes(t)) {
        const list = (window.Inventory?.list() || []);
        typeText(list.length ? "Ekwipunek: " + list.join(", ") : "Ekwipunek jest pusty.");
        cmd.value=""; cmd.focus(); return;
      }

      const handled = SM.handle(t);
      if(!handled){
        typeText("Nie rozumiem. " + (available.length ? "Komendy: " + available.join(", ") + "." : ""));
      }
      cmd.value = ""; cmd.focus();
    }
    send.addEventListener('click', handleInput);
    cmd.addEventListener('keydown', e => { if(e.key === "Enter"){ e.preventDefault(); handleInput(); } });
    speed.addEventListener('input', () => { speedIdx = +speed.value; speedLabel.textContent = labels[speedIdx]; });
    speedLabel.textContent = labels[speedIdx];
    fastBtn.addEventListener('click', () => { speedIdx = 0; speed.value = 0; speedLabel.textContent = labels[0]; });
    restartBtn.addEventListener('click', () => { window.SAN?.reset?.(100); window.location.reload(); });
    continueBtn.addEventListener('click', (e)=>{ if(continueBtn.disabled){ e.preventDefault(); e.stopPropagation(); } });

    /* ===== Game State & Dice ===== */
    const G = {
      windowRoll:null, sawDrop:false, dressed:false,
      stairsRoll:null, ribbonRoll:null, itemFound:false,
    };
    function rollOnce(field){
      const v = G[field];
      if (typeof v === "number" && v >= 1 && v <= 6) return v;
      const r = Math.floor(Math.random() * 6) + 1;
      G[field] = r;
      return r;
    }

    /* ===== Common assets ===== */
    const WINDOW_ART = "run.png";

    /* ===== Scenes ===== */
    SM.reg("start", {
      async enter(){
        setCmds(["podejdź do okna","idź spać","pomoc"]);
        await say([
          "Stoisz samotnie, w ciszy swojego pokoju. Wciąż pamiętasz hałas dochodzacy z zewnątrz.",
          "Możesz podejść do okna, albo po prostu położyć się i spróbować zasnąć."
        ]);
      },
      handle(t){
        if(t==="podejdź do okna"){ SM.go("okno"); return true; }
        if(t==="idź spać"){ SM.go("sen"); return true; }
        if(["pomoc","?","help"].includes(t)){ typeText("Dostępne: podejdź do okna / idź spać."); return true; }
      }
    });

    function showArt(src, alt=""){
      const d = writeLine("");
      const img = new Image();
      img.loading = "lazy";
      img.src = src;
      img.alt = alt;
      img.className = "art";
      d.appendChild(img);
      scrollBottom();
    }

    SM.reg("okno", {
      async enter(){
        setCmds(["przyjrzyj się postaci","wyjdź na klatkę","idź spać","pomoc"]);
        await say([
          "Podchodzisz do okna. Szyba jest zimna w dotyku, para z oddechu osiada na jej powierzchni.",
          "W blasku latarni przed kamienicą widzisz przewrócony kosz na śmieci. Serce bije ci mocniej.",
          "Ktoś w długim płaszczu i kapeluszu oddala się pospiesznie."
        ]);
        showArt(WINDOW_ART, "Widok z okna: przewrócony kosz i sylwetka w kapeluszu znikająca we mgle");
      },
      handle(t){
        const r = rollOnce("windowRoll");
        if(t==="przyjrzyj się postaci"){
          if(r<=2){ typeText(`Mgła połyka szczegóły. Nie potrafisz niczego dojrzeć. (wynik: ${r})`); }
          else if(r<=4){ typeText(`Na ramieniu postaci dostrzegasz jakiś przedmiot — wygląda na aparat fotograficzny. (wynik: ${r})`); if(window.Sanity) Sanity.add(-1,"pursuit:window-apparatus"); }
          else { typeText(`Postać ma przy sobie aparat fotograficzny… i coś wypada jej z kieszeni na chodnik. (wynik: ${r})`); G.sawDrop = true; if(window.Sanity) Sanity.add(-1,"pursuit:window-drop"); }
          return true;
        }
        if(t==="wyjdź na klatkę"){ SM.go("przebranie"); return true; }
        if(t==="idź spać"){ SM.go("sen"); return true; }
        if(["pomoc","?","help"].includes(t)){ typeText("Dostępne: przyjrzyj się postaci / wyjdź na klatkę / idź spać."); return true; }
      }
    });

    SM.reg("przebranie",{
      async enter(){
        setCmds(G.dressed ? ["wyjdź na klatkę","pomoc"] : ["przebierz się","pomoc"]);
        if(!G.dressed){
          await say([
            "Dotykasz klamki. Otwierasz drzwi. Zimno... w pidżamie nie pójdziesz.",
            "Najpierw musisz się przebrać."
          ]);
        } else {
          await typeText("Jesteś już przebrany. Możesz wyjść na klatkę.");
        }
      },
      handle(t){
        if(t==="przebierz się" && !G.dressed){
          G.dressed = true;
          setCmds(["wyjdź na klatkę","pomoc"]);
          typeText("Wciągasz na siebie spodnie, sweter, buty. Zimno nie powinno być problemem.");
          return true;
        }
        if(t==="wyjdź na klatkę" && G.dressed){ SM.go("klatka"); return true; }
        if(["pomoc","?","help"].includes(t)){ typeText(G.dressed ? "Dostępne: wyjdź na klatkę." : "Dostępne: przebierz się."); return true; }
      }
    });

    SM.reg("klatka",{
      async enter(){
        setCmds(["rozejrzyj się","idź do kosza","pomoc"]);
        await say([
      "Wychodzisz na klatkę. Zimno bije od ścian, pachie wilgocią.",
      "Wszystko wydaje się na swoim miejscu. Skrzynki i tablica przy wejściu, nieczynna winda, małe okienko, słaba żarówka nad nimi.",
      "Nie ma czasu się przyglądać. Z każdą minutą tajemnicza postać jest coraz dalej — z dołu słychać jednostajne buczenie domofonu."
    ]);
      },
      handle(t){
        if (["rozejrzyj się","rozejrzyj","rozejrzyj sie"].includes(t)){
          const r = rollOnce("stairsRoll");
          if (r <= 3){
            typeText(`Szara posadzka, wilgotne ściany. Nic szczególnego. (wynik: ${r})`);
          } else {
            typeText(`Na posadzce dostrzegasz mokre ślady małych stóp. Zosia? (wynik: ${r})`);
            if (window.Sanity) Sanity.add(-1, "pursuit:stairs-prints");
          }
          return true;
        }
        if (t === "idź do kosza"){ SM.go("kosz"); return true; }
        if (["pomoc","?","help"].includes(t)){ typeText("Dostępne: rozejrzyj się / idź do kosza."); return true; }
      }
    });

    SM.reg("kosz",{
      async enter(){
        const cmds = ["rozejrzyj się","idź w stronę latarni","pomoc"];
        if(G.sawDrop && !G.itemFound) cmds.unshift("podnieś przedmiot");
        if(!G.itemFound) cmds.unshift("przeszukaj miejsce");
        setCmds(cmds);
        await say([
          "Wychodzisz na zewnątrz. Mgła smakuje żelazem, jak krew, jak ostrze noża na języku.",
          "Pod latarnią leży przewrócony kosz, zawartość rozsypała się po mokrym chodniku."
        ]);
        if(G.sawDrop) writeLine("<span class='accent'>Pamiętasz, że coś upadło tutaj przed chwilą.</span>");
      },
      handle(t){
        if (t==="rozejrzyj się"){
          typeText("Przy rozchlapywanych kałużach widać odciski butów dorosłego. Biegną w stronę pobliskiej bramy.");
          return true;
        }
        if(t==="przeszukaj miejsce" && !G.itemFound){
          const r = Math.floor(Math.random()*6)+1;
          if(r<=3){ typeText(`Rozgarniasz śmieci butem. Nic wartościowego. (wynik: ${r})`); }
          else{
            G.itemFound = true;
            if(window.Inventory){ try{ Inventory.add("wycinek z gazety"); }catch(e){} }
            addCmd("przeczytaj artykuł");
            removeCmd("przeszukaj miejsce");
            typeText("Pod mokrym kartonem znajdujesz złożony na czworo, stary wycinek prasowy. Bierzesz go.");
          }
          return true;
        }
        if(t==="podnieś przedmiot" && G.sawDrop && !G.itemFound){
          G.itemFound = true;
          if(window.Inventory){ try{ Inventory.add("wycinek z gazety"); }catch(e){} }
          addCmd("przeczytaj artykuł");
          removeCmd("przeszukaj miejsce");
          typeText("Podnosisz to, co upadło: wycinek gazety, pospiesznie wyrwany z większej strony.");
          return true;
        }
        if(t==="przeczytaj artykuł" && G.itemFound){
          const fragment = `„ZAGINIĘŁA DZIEWCZYNKA W CICHYM WZGÓRZU”
    Autor: red. lokalny, „Gazeta Nadmorska”

    Wciąż nie milkną echa sprawy, która od miesięcy spędza sen z powiek mieszkańców Cichego Wzgórza. 
    Siedmioletnia Zosia K., wychowanka miejscowego sierocińca,
    zniknęła bez śladu w listopadowy wieczór. Dziewczynkę ostatni raz widziano,
    gdy bawiła się w pobliżu lasu, zaledwie kilkaset metrów od budynku placówki.

    Zaginięcie zgłosili jeszcze tej samej nocy pracownicy sierocińca. Policja wraz z ochotnikami rozpoczęła 
    szeroko zakrojone poszukiwania — przeczesywano las, pola, okolice jeziora i stare zabudowania. 
    W akcji brały udział psy tropiące, jednak trop urywał się tuż przy ogrodzeniu sierocińca.

    Świadkowie twierdzą, że widzieli sylwetkę dziecka, które biegło w stronę miasteczka,
    a potem „jakby rozpłynęło się we mgle”. Inni mówią o podejrzanym mężczyźnie w długim płaszczu,
    który kręcił się w tamtej okolicy. 
    Policja nie potwierdza tych doniesień, lecz nie wyklucza, że ktoś mógł śledzić dziewczynkę.

    Mimo intensywnych działań, do dziś nie odnaleziono żadnych śladów Zosi. 
    Zabezpieczono jedynie drobne przedmioty — czerwoną wstążkę, którą dziewczynka nosiła we włosach.

    Mieszkańcy Cichego Wzgórza żyją w poczuciu niepewności. Starsi wspominają,
    że to nie pierwsze tajemnicze zniknięcie dziecka w tej okolicy. Plotki sięgają dawnych lat,
    kiedy w okolicy "podobno" dochodziło do dziwnych zdarzeń, o których nigdy oficjalnie nie pisano.

    Policja zapewnia, że sprawa nie została zamknięta. Dochodzenie wciąż trwa, choć — jak przyznają 
    sami funkcjonariusze — bez nowych dowodów coraz trudniej wierzyć w szczęśliwy finał.`;
          try{ localStorage.setItem('cw.articleFragment', fragment); }catch(e){}
          typeText(fragment);
          if (window.Sanity) Sanity.add(-1, "pursuit:article");
          return true;
        }
        if(t==="idź w stronę latarni"){ SM.go("latarnia"); return true; }
        if(["pomoc","?","help"].includes(t)){
          typeText("Dostępne: " + (G.itemFound ? "rozejrzyj się / przeczytaj artykuł / idź w stronę latarni." :
                      (G.sawDrop ? "rozejrzyj się / podnieś przedmiot / przeszukaj miejsce / idź w stronę latarni." :
                                    "rozejrzyj się / przeszukaj miejsce / idź w stronę latarni.")));
          return true;
        }
      }
    });

    SM.reg("latarnia",{
      async enter(){
        setCmds(["skręć w bramę","pomoc"]);
        await say([
          "Podchodzisz pod latarnię. Światło jest chore, żółte, rozlane po asfalcie.",
          "Na ziemi odciśnięte ślady butów znikają przy bramie między kamienicami."
        ]);
      },
      handle(t){
        if(t==="skręć w bramę"){ SM.go("brama"); return true; }
        if(["pomoc","?","help"].includes(t)){ typeText("Dostępne: skręć w bramę."); return true; }
      }
    });

    // >>> POCZĄTEK ZMIANY <<<
    SM.reg("brama", {
        async enter(){
            setCmds([]); // Wyłączenie komend na czas sceny
            await say([
                "Wchodzisz w mroczną czeluść bramy. Mgła gęstnieje, pachnie stęchlizną i czymś metalicznym.",
                "Stawiasz krok w głąb ciemności.",
                "Nagle czujesz, jak coś miękkiego ociera się o twoją nogę."
            ], 400);

            await new Promise(r=>setTimeout(r, 800)); // Pauza dla efektu
            
            if (window.Sanity) {
                Sanity.add(-1, "pursuit:gate-touch");
                if (Sanity.effect) Sanity.effect("glitch");
            }

            await typeText("Zanim zdążysz zareagować, świat wokół ciebie zaczyna się rozpływać...");
            await new Promise(r=>setTimeout(r, 1200)); // Pauza przed przejściem

            // Przekierowanie do sceny obłędu
            const here = new URL(location.href);
            here.searchParams.set('afterObled','1');
            const ret = encodeURIComponent(here.href);
            location.href = `obled.html?return=${ret}`;
        },
        handle(){ return true; } // Brak komend do obsłużenia
    });
    // >>> KONIEC ZMIANY <<<

    /* Pozostawiamy 'uliczka' na wypadek innych ścieżek */
    SM.reg("uliczka",{
      async enter(){
        setCmds(["zostań w bezruchu","pomoc"]);
        await say([
          "Wychodzisz na uliczkę. Mgła gęstnieje.",
          "Coś otarło ci się o nogę.",
          "Powietrze gęstnieje. Latarnia mruga i gaśnie jednym, krótkim błyskiem."
        ]);
      },
      handle(t){
        if(t==="zostań w bezruchu"){
          if (window.Sanity){
            const loss = (Math.floor(Math.random()*4)+1) + (Math.floor(Math.random()*4)+1); // 2k4
            Sanity.add(-loss, "pursuit:alley-freeze");
            if (Sanity.effect) Sanity.effect("shake");
            typeText(`Zastyga ci krew w żyłach. Poczytalność -${loss}.`);
          }
          SM.go("koniec"); return true;
        }
        if(["pomoc","?","help"].includes(t)){ typeText("Dostępne: zostań w bezruchu."); return true; }
      }
    });

    /* Scena po powrocie z obłędu */
    SM.reg("poObledzie",{
      async enter(){
        setCmds([]);
        await say([
          "Wracasz… ale nie możesz ustać na nogach.",
          "Opadasz na kolana.",
          "Oślepiający błysk rozcina mrok. Przymykasz powieki..."
        ], 360);
        if (window.Sanity?.effect) Sanity.effect("shake");
        await new Promise(r=>setTimeout(r,600));
        await SM.go("sen");
      },
      handle(){ return true; }
    });

    SM.reg("sen",{
      async enter(){
        setCmds(["przejdź dalej","dalej","pomoc"]);
        const DREAM_LINES = [
          "Zamykasz oczy. Ciemność pochłania cię niczym żywa istota.",
          "Ponownie znajdujesz się w lesie, ale kora drzew jest czerwona i wilgotna.",
          "Gałęzie przypominają nabrzmiałe żyły, z których kapie gęsta, czarna żywica.",
          "Z ziemi wynurza się twarz dziecka. Wpatrują się w ciebie puste oczodoły, jamy pełne tłustych larw.",
          "Dziecięce palce szarpią ziemię.",
          "Gałęzie wyginają się, chwytają twoje nadgarstki.",
          "Czujesz jak kora rozdziera skórę do kości.",
          "Pod stopami coś obrzydliwie mlaska. To... to języki, które liżą twoje stopy.",
          "Rozbrzmiewa bicie dzwonu. Każdy dźwięk rozsadza ci czaszkę, a z uszu zaczyna sączyć się gorąca ropa.",
          "Na polanie płoną czerwone świece. Topnieją, a w wosku wiją się odcięte palce.",
          "Wosk ścieka po pniach, zostawiając blizny.",
          "Cienie tańczą. Ale ich kończyny są za długie, wykręcone, obdarte ze skóry.",
          "Dotykasz ziemi — jest lepka. Pod palcami ruszają się robaki, które wgryzają się pod paznokcie.",
          "Czujesz, jak drążą tunele w twoich dłoniach.",
          "W oddali błyska błękit sukienki. Ale materiał jest przybrudzony, nasiąknięty krwią.",
          "Dziewczęce włosy są mokre, posklejane. Wplątane w nie zęby i kości służą za ozdoby.",
          "Wołasz. Gardło wydaje tylko charkot, z ust unoszą się bąble krwi.",
          "Czerwona wstążka drży na pniu. Ale gdy ją chwytasz, zamienia się w język.",
          "Język owija się wokół twojego nadgarstka.",
          "Niebo pęka. Z góry spada popiół.",
          "Za plecami trzask. Aparat fotograficzny. Migawka błyska raz za razem.",
          "Odwracasz się. Wysoka sylwetka. Kapelusz. Brak twarzy.",
          "Ziemia pod stopami jest mięsem. Twoje stopy zapadają się w tkankę.",
          "Coś pod spodem oddycha.",
          "Upadasz w ciemność. Ale ciemność nie jest próżnią — jest jamą pełną zębów.",
          "Widzisz światła samochodu. Ale to nie reflektory. To żółte, gnijące oczy.",
          "Słyszysz zawodzenie, przeciągłe jak ryk konającej bestii.",
          "„Jedź. Czekam.” — głos rozsadza twoją głowę.",
          "Zęby zaczynają ci się ruszać i wypadają, jeden po drugim.",
          "Widzisz siebie — dziecko, starca, kobietę, trupa, zwierzę.",
          "Wszystkie wersje ciebie płaczą krwią i śmieją się jednocześnie.",
          "Z ich jam brzusznych wysuwają się macki, które wiją się ku niebu.",
          "Niebo pęka na tysiące kawałków.",
          "Krzyk drapie w krtań, aż czujesz krew w płucach.",
          "Z oceanu ciemności wynurza się coś ogromnego.",
          "Nie widzisz całości, tylko fragmenty. Oko wielkości wszechświata.",
          "Kiedy patrzysz, tracisz rozum. Twoja twarz rozsypuje się w popiół.",
          "W krwi i popiele widzisz trzy sylwetki.",
          "Kobiety, które znasz, choć ich twarze są zamazane.",
          "Jedna prowadzi samochód, dłonie zaciskają się na kierownicy, aż bieleją knykcie.",
          "Druga szkicuje coś w ciemnym zeszycie.",
          "Trzecia patrzy w bok, uśmiecha się, choć usta ma zaszyte grubą nicią.",
          "Słyszysz ich głosy: „Razem. Musimy wrócić. Razem.”",
          "Droga wije się w mroku, prowadzi ku szczytowi.",
          "Cicha Góra czeka — wzywa was wszystkich.",
          "Wiesz, że jeśli nie zabierzesz ich ze sobą, nigdy nie odnajdziesz prawdy.",
          "Wiesz, że los was wszystkich jest spleciony z tym miejscem.",
          "Na ziemi pojawia się napis, ułożony z fragmentów kości i odciętych włosów: „Jedź z nimi”.",
          "Śmiech i płacz mieszają się w jeden dźwięk.",
          "A potem wezwanie, które nie cichnie.",
          "Ostatnie co widzisz, to słowo, wypalone w powietrzu czerwonym ogniem:",
          "Z O S I A.",
          "Potem już tylko śmiech. Śmiech, który trwa w nieskończoność."
        ];
        await say(DREAM_LINES, 430);
        await new Promise(r=>setTimeout(r,450));
        if (window.Sanity){
          const r = Math.floor(Math.random()*4)+1;
          Sanity.add(-r,"pursuit:dream-k4");
        }
        showContinue(NEXT_FILE, "Przejdź dalej");
      },
      handle(t){
        if (["przejdź dalej","dalej","idź dalej","idz dalej","naprzód","naprzod"].includes(t)){
          if (!continueBtn.disabled) { continueBtn.click(); return true; }
        }
        if(["pomoc","?","help"].includes(t)){ typeText("Kliknij „Przejdź dalej” albo wpisz: przejdź dalej / dalej."); return true; }
      }
    });

    /* Zachowujemy „koniec” na wypadek alternatywnych ścieżek */
    SM.reg("koniec",{
      async enter(){
        setCmds([]);
        await say([
          "Z mroku wyłania się wysoka sylwetka.",
          "Kapelusz, długi płaszcz… i brak twarzy.",
          "Ziemia się kołysze. Kolana uginają się."
        ], 360);
        await typeText("Czarny tunel zasysa cię do środka — mdlejesz.");
        await new Promise(r=>setTimeout(r,600));
        await SM.go("sen");
      },
      handle(){ return true; }
    });

    /* ===== Boot: jeśli wracamy z obłędu, idź od razu do koszmaru ===== */
    const url = new URL(location.href);
    const afterObled = url.searchParams.get("afterObled") === "1";
    if (afterObled) {
      SM.go("poObledzie");
    } else {
      SM.go("start");
    }
  })();
  </script>
</body>
</html>