<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ciche Wzg√≥rze ‚Äî Pok√≥j</title>
<style>
  :root{ --bg:#07090c; --fg:#e6e6e6; --muted:#9aa0a6; --accent:#c7a26d; }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0;
    background:radial-gradient(1200px 800px at 70% -10%, #11161e 0%, #07090c 60%, #05070a 100%);
    color:var(--fg);
    font:16px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Ubuntu,Cantarell
  }
  .wrap{max-width:920px; margin:0 auto; padding:24px 16px 120px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px}
  h1{font-size:20px; margin:0; letter-spacing:.02em; color:#f1f1f1}
  .pill{display:inline-block; padding:.25em .6em; border:1px solid rgba(255,255,255,.12);
    border-radius:999px; font-size:12px; color:#cbd5e1; margin-right:6px}
  .panel{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.07);
    border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,.35);
    display:flex; flex-direction:column;}
  #log{height:60vh; min-height:340px; overflow:auto; padding:18px 18px 6px; scrollbar-width:thin}
  #log::-webkit-scrollbar{height:8px; width:8px}
  #log::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1); border-radius:20px}
  .line{margin:0 0 14px; opacity:.96}
  .type{border-right:2px solid rgba(255,255,255,.65); animation:caret .85s steps(1) infinite}
  @keyframes caret{50%{border-color:transparent}}
  .toolbar{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:14px;
    padding:10px 12px; border-top:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02))}
  input[type=range]{accent-color:#b5c4ff}
  button{padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.06); color:var(--fg); cursor:pointer}
  button:hover{background:rgba(255,255,255,.1)}
  .sep{opacity:.35; margin:0 .25em}
  #inputbar{display:flex; gap:10px; padding:10px; border-top:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02))}
  #cmd{flex:1; padding:12px 14px; border-radius:10px;
    border:1px solid rgba(255,255,255,.08); background:rgba(3,6,9,.6); color:var(--fg); outline:none}
  #cmd::placeholder{color:#8892a6}
  .note{color:var(--muted); font-size:13px; margin-top:8px}

  /* overlay dla pikselartu lustra */
  .mirror-overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.85); z-index:9999; opacity:0; transition:opacity .35s ease;
  }
  .mirror-overlay.show{ opacity:1; }
  .mirror-overlay img{
    max-width:80vw; max-height:80vh; image-rendering: pixelated;
    border-radius:12px; box-shadow:0 12px 36px rgba(0,0,0,.6);
  }

  /* üü¢ DODAJ: CSS efekt√≥w SAN (kopiuj ca≈Ço≈õƒá poni≈ºej) */
  /* === SANITY FX (CSS) === */
  #sanFx{position:fixed; inset:0; pointer-events:none; z-index:50}
  #sanFx .vig{position:absolute; inset:-10%; background:
    radial-gradient(70% 70% at 50% 50%, transparent 45%, rgba(0,0,0,.65) 100%);
    opacity:0; transition:opacity .35s ease}
  #sanFx .scan{position:absolute; inset:0;
    background:repeating-linear-gradient(to bottom, rgba(255,255,255,.035) 0 2px, rgba(0,0,0,0) 2px 4px);
    mix-blend-mode:overlay; opacity:0; transition:opacity .35s ease}

  body.san-t2 .panel{filter:saturate(.9) contrast(1.03)}
  body.san-t3 .panel{filter:hue-rotate(-6deg) saturate(.85) contrast(1.06)}
  body.san-t4 .panel{filter:hue-rotate(-12deg) saturate(.75) contrast(1.1) blur(.3px)}
  body.san-t5 .panel{filter:hue-rotate(-18deg) saturate(.6) contrast(1.18) blur(.6px)}
  body.san-t3 #sanFx .vig{opacity:.28}
  body.san-t4 #sanFx .vig{opacity:.5}
  body.san-t5 #sanFx .vig{opacity:.72}
  body.san-t4 #sanFx .scan{opacity:.15}
  body.san-t5 #sanFx .scan{opacity:.28}

  @keyframes sanJitter {
    0%, 97%, 100% { transform:translate3d(0,0,0) }
    98% { transform:translate3d(.6px,-.6px,0) }
    99% { transform:translate3d(-.7px,.5px,0) }
  }
  body.san-t4 .panel, body.san-t5 .panel { animation:sanJitter 7.5s infinite }
  body.san-t5 #log .line{
    text-shadow: 1px 0 rgba(255,0,0,.28), -1px 0 rgba(0,255,255,.22);
  }
  /* === /SANITY FX (CSS) === */
</style>
</head>

<!-- üü¢ DODAJ: overlay FX tu≈º po <body> -->
<body>
  <!-- SAN overlay -->
  <div id="sanFx" aria-hidden="true">
    <div class="vig"></div>
    <div class="scan"></div>
  </div>
  <!-- /SAN overlay -->

  <div class="wrap">
    <header>
      <h1>Ciche Wzg√≥rze ‚Äî Pok√≥j</h1>
      <div>
        <!-- üü¢ DODAJ: badge SAN w nag≈Ç√≥wku -->
        <span class="pill" id="sanBadge" title="Poczytalno≈õƒá (SAN)">
          <strong>SAN</strong>&nbsp;<span id="sanVal">‚Äî</span>
        </span>
      </div>
    </header>

    <section class="panel">
      <div id="log" aria-live="polite"></div>
      <div class="toolbar">
        <button id="replay">Restart sceny</button>
        <button id="fast">Przyspiesz</button>
        <span class="sep">|</span>
        <span>Tempo</span>
        <input type="range" id="speed" min="0" max="3" step="1" value="3" />
        <span id="speedLabel">powoli</span>
        <span class="sep">|</span>
        <button id="continue" disabled>Przejd≈∫ dalej</button>
      </div>
      <div id="inputbar">
        <input id="cmd" autocomplete="off" spellcheck="false"
          placeholder="komendy: rozejrzyj siƒô, wsta≈Ñ..." />
        <button id="send">Wy≈õlij</button>
      </div>
    </section>
    <p class="note" id="hint" style="display:none"></p>
  </div>

<!-- üü¢ DODAJ: sanity.js PRZED inventory.js -->
<script src="sanity.js"></script>
<!-- === SAN PERSIST (localStorage) ‚Äî WKLEJ TUTAJ === -->
<script>
(() => {
  const SAN_KEY = "cw.san.v1";
  const clamp = v => Math.max(0, Math.min(100, v|0));
  const loadSAN = () => {
    const raw = localStorage.getItem(SAN_KEY);
    const n = +raw;
    return Number.isFinite(n) ? clamp(n) : 100;
  };
  const saveSAN = v => { try{ localStorage.setItem(SAN_KEY, String(clamp(v))); }catch(e){} };

  // helpery globalne
  window.SAN = {
    key: SAN_KEY,
    load: loadSAN,
    save: saveSAN,
    reset(v=100){
      try{ localStorage.removeItem(SAN_KEY); }catch(e){}
      saveSAN(v);
      if (window.Sanity?.set) Sanity.set(v);
    }
  };

  // synchronizacja miƒôdzy kartami
  window.addEventListener("storage", (e) => {
    if (e.key === SAN_KEY && e.newValue != null && window.Sanity?.set) {
      const next = clamp(+e.newValue);
      if (Number.isFinite(next) && window.Sanity?.get && Sanity.get() !== next) {
        Sanity.set(next);
      }
    }
  });
})();
</script>
<!-- POD≈ÅƒÑCZENIE EKWIPUNKU (globalne API: window.Inventory) -->
<script src="inventory.js"></script>

<script>
(() => {
  /* ===== Typewriter / UI bazowe ===== */
  const SPEEDS = [0, 2, 10, 60];
  let speedIdx = 3;
  const labels = ["natychmiast","szybko","standard","powoli"];

  const log = document.getElementById('log');
  const replayBtn = document.getElementById('replay');
  const fastBtn = document.getElementById('fast');
  const speed = document.getElementById('speed');
  const speedLabel = document.getElementById('speedLabel');
  const continueBtn = document.getElementById('continue');
  const cmd = document.getElementById('cmd');
  const send = document.getElementById('send');
  const hint = document.getElementById('hint');

  /* üü¢ DODAJ: SAN bootstrap (logika prog√≥w, szept√≥w, glitchy) */
  // ===== SANITY bootstrap =====
  const sanValElHeader = document.getElementById("sanVal");
  let sanTypeFactor = 1;
  let sanWhisperTimer = null;
  let sanScrambleTimer = null;

  function tierFor(v){ return v>=80?1 : v>=60?2 : v>=40?3 : v>=20?4 : 5; }
  function applySanityTier(t){
    document.body.classList.remove('san-t1','san-t2','san-t3','san-t4','san-t5');
    document.body.classList.add('san-t'+t);
    sanTypeFactor = [1.0, 0.95, 0.9, 0.85, 0.8][t-1] || 1;

    if (sanWhisperTimer) { clearInterval(sanWhisperTimer); sanWhisperTimer = null; }
    if (t >= 4) {
      sanWhisperTimer = setInterval(()=>{
        if (Math.random() < 0.35) {
          const pool = ["‚Ä¶to nie ona‚Ä¶","‚Ä¶nie odwracaj siƒô‚Ä¶","‚Ä¶s≈Çyszysz?‚Ä¶","‚Ä¶nie jeste≈õ sam‚Ä¶","‚Ä¶znowu patrzƒÖ‚Ä¶"];
          writeLine(`<span class="line" style="color:#aeb4bd;font-style:italic;opacity:.8">${pool[Math.floor(Math.random()*pool.length)]}</span>`);
        }
      }, 9000);
    }
    if (sanScrambleTimer) { clearInterval(sanScrambleTimer); sanScrambleTimer = null; }
    if (t === 5) {
      sanScrambleTimer = setInterval(()=> scrambleLogOnce(0.10, 160), 900);
    }
  }
  function scrambleLogOnce(intensity=0.10, duration=150){
    const spans = log?.querySelectorAll('.line span, .line') || [];
    if (!spans.length) return;
    const target = spans[Math.floor(Math.random()*spans.length)];
    const original = target.textContent;
    if (!original || original.length < 2) return;
    const idx = Math.max(1, Math.floor(original.length * intensity));
    let chars = original.split('');
    for (let i = 0; i < idx; i++) {
      const p = Math.floor(Math.random() * chars.length);
      if (!/\s/.test(chars[p])) {
        const code = chars[p].codePointAt(0);
        chars[p] = String.fromCodePoint(code + 1);
      }
    }
    target.textContent = chars.join('');
    setTimeout(() => { target.textContent = original; }, duration + Math.floor(Math.random()*120));
  }
  function syncSan(v){
    if (sanValElHeader) sanValElHeader.textContent = `${v}/100`;
    applySanityTier(tierFor(v));
  }
if (window.Sanity && typeof Sanity.init === "function") {
  // start z localStorage zamiast twardego 100
  const _startSAN = (window.SAN?.load ? window.SAN.load() : 100);
  Sanity.init({ start: _startSAN, mount: ".toolbar" });

  // zapis ka≈ºdej zmiany + od≈õwie≈ºenie UI
  const _onSanChange = (v) => { try{ window.SAN?.save?.(v); }catch(e){}; syncSan(v); };

  if (typeof Sanity.subscribe === "function")      Sanity.subscribe(_onSanChange);
  else if (typeof Sanity.onChange === "function")  Sanity.onChange(_onSanChange);

  syncSan(Sanity.get?.() ?? _startSAN);
} else {
  syncSan(window.SAN?.load?.() ?? 100); // fallback te≈º czyta z localStorage
}
  // ===== /SANITY bootstrap =====

  function scrollBottom(){ log.scrollTop = log.scrollHeight; }
  function writeLine(html){
    const d=document.createElement('div');
    d.className='line'; d.innerHTML=html;
    log.appendChild(d); scrollBottom(); return d;
  }
  async function typeText(text){
    const d = writeLine(""); const s=document.createElement('span');
    s.className="type"; d.appendChild(s);
    /* üü° ZAMIE≈É: obliczanie ms (≈ºeby zale≈ºa≈Ço od SAN) */
    // const ms=SPEEDS[speedIdx];
    const base = SPEEDS[speedIdx];
    const ms = Math.max(0, Math.round(base * sanTypeFactor));

    if(ms<=0){ s.textContent=text; s.classList.remove('type'); return; }
    for(const ch of text){ s.textContent+=ch; await new Promise(r=>setTimeout(r,ms)); scrollBottom(); }
    s.classList.remove('type');
  }
  function type(t){ return typeText(t); }

  /* üîµ OPCJONALNE: glitche liter przy bardzo niskim SAN (je≈õli sanity.js udostƒôpnia wrapTypeText) */
  if (window.Sanity && typeof Sanity.wrapTypeText === "function") {
    const _orig = typeText;
    type = (txt)=> (Sanity.get && Sanity.get()<20 ? Sanity.wrapTypeText(_orig)(txt) : _orig(txt));
  }

  function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
  function writePrompt(t){ writeLine("&gt; "+escapeHtml(t)); }

  let availableCommands = [];
  function setCommands(arr){ availableCommands = arr.slice(); updateHint(); }
  function addCommand(c){ if(!availableCommands.includes(c)){ availableCommands.push(c); updateHint(); } }
  function updateHint(){
    hint.style.display = "block";
    hint.innerHTML = "Komendy: " + availableCommands.map(c => "<b>"+c+"</b>").join(", ") + ".";
  }

  // POMOCNICZE: aktywuj przycisk ‚ÄûPrzejd≈∫ dalej‚Äù
  function showContinue(url, label="Przejd≈∫ dalej"){
    continueBtn.textContent = label;
    continueBtn.disabled = false;
    continueBtn.onclick = () => { window.location.href = url; };
  }

  // === Preload i overlay dla pixelartu lustra ===
  const preloadMirrorArt = (src='mirror_art.png') => { const i=new Image(); i.src=src; };
  preloadMirrorArt();

  function showMirrorArt(filename='mirror_art.png', visibleMs=1800){
    const overlay = document.createElement('div');
    overlay.className = 'mirror-overlay';
    overlay.innerHTML = `<img src="${filename}" alt="Pikselowy kadr: mƒô≈ºczyzna patrzy w lustro, obok odbicia majaczy niejasna sylwetka" loading="lazy">`;
    document.body.appendChild(overlay);
    // wymu≈õ reflow i fade-in
    overlay.getBoundingClientRect();
    overlay.classList.add('show');

    const onEsc = (e)=>{ if(e.key==='Escape'){ cleanup(); } };
    document.addEventListener('keydown', onEsc);

    function cleanup(){
      overlay.classList.remove('show');
      setTimeout(()=> overlay.remove(), 300);
      document.removeEventListener('keydown', onEsc);
    }
    setTimeout(cleanup, visibleMs);
  }

  const SceneManager = {
    current:null, scenes:{},
    register(n,s){ this.scenes[n]=s; },
    async goTo(n){
      if(this.current && this.scenes[this.current].exit) this.scenes[this.current].exit();
      this.current=n; if(this.scenes[n].enter) await this.scenes[n].enter();
    },
    handle(t){
      const s = this.scenes[this.current];
      if(!s || !s.handle) return false;
      return !!s.handle(t);
    }
  };
/* ===================== SCENA: ROOM ===================== */
SceneManager.register("room", (function(){
  const S = {
    lampOn:false, haveLetter:false, letterRead:false,
    drawerOpen:false, keyFound:false, diaryRead:false,
    mirrorChecked:false,
    envelopeRoll:null, letterInspectRoll:null
  };

  function enter(){
    setCommands(["rozejrzyj siƒô","wsta≈Ñ","pomoc","ekwipunek"]);
    type("Pobudka jest gwa≈Çtowna. Serce dudni ci w piersi. Wok√≥≈Ç panuje p√≥≈Çmrok. Spr√≥buj siƒô rozejrzeƒá...");
    cmd.focus();
  }

  function lookRoom(){
    if(!S.lampOn){
      type("Ciemno≈õƒá skrywa wiƒôkszo≈õƒá pomieszczenia. Ledwo widzisz kontury mebli. Najbli≈ºej ciebie stoi stolik z lampkƒÖ nocnƒÖ.");
      addCommand("zapal lampkƒô");
    } else {
      type("Ciep≈Çy krƒÖg ≈õwiat≈Ça odgania mrok. Na stoliku le≈ºy koperta. Szuflada jest lekko uchylona. Budzik pokazuje: 3:03.");
    }
  }

  const standUp = ()=> type("Siadasz na ≈Ç√≥≈ºku. Pod≈Çoga skrzypi pod tobƒÖ.");

  function lamp(on=true){
    if(on && S.lampOn){ type("Lampka ju≈º ≈õwieci."); return; }
    if(!on && !S.lampOn){ type("I tak jest ciemno."); return; }
    S.lampOn = on;
    if(on){
      type("Klik. ≈öwiat≈Ço rozprasza cienie. Widzisz wyra≈∫nie swoje mieszkanie. Nic specjalnego, kilka mebli, masa ksiƒÖ≈ºek, stolik z lekko uchylonƒÖ szufladƒô, a na nim kopertƒô. Prze≈Çykasz ≈õlinƒô. Jeste≈õ pewien, ≈ºe gdy siƒô k≈Çad≈Çe≈õ jej tam nie by≈Ço. Kto≈õ musia≈Ç siƒô zakra≈õƒá do mieszkania i jƒÖ podrzuciƒá, kiedy spa≈Çe≈õ.");
      addCommand("we≈∫ list");
      addCommand("przeszukaj szufladƒô");
    } else {
      type("Klik. Znowu ciemno.");
    }
  }

  function takeLetter(){
    if(!S.lampOn){ type("W ciemno≈õci nie chcesz grzebaƒá przy stoliku. Zapal lampkƒô."); return; }
    if(S.haveLetter){ type("List ju≈º masz."); return; }
    S.haveLetter = true;
    type("Bierzesz kopertƒô. Papier jest stary i zawilgotnia≈Çy.");
    addCommand("przyjrzyj siƒô kopercie");
    addCommand("przyjrzyj siƒô listowi");
    addCommand("czytaj list");
    // dodaj do ekwipunku
    if(window.Inventory) Inventory.add("koperta z listem");
  }

  function rollOnce(field){
    if(S[field]!==null) return S[field];
    const r = Math.floor(Math.random()*6)+1;
    S[field] = r; return r;
  }

  function inspectEnvelope(){
    if(!S.lampOn){ type("Za ciemno, ≈ºeby przyglƒÖdaƒá siƒô kopercie."); return; }
    if(!S.haveLetter){ type("Najpierw we≈∫ kopertƒô ze stolika."); return; }
    const r = rollOnce("envelopeRoll");
    if(r<=2){
      type("PrzyglƒÖdasz siƒô kopercie, ale nic szczeg√≥lnego nie rzuca siƒô w oczy (wynik: "+r+").");
    } else if(r<=4){
      type("Na stemplu pocztowym widzisz: ‚ÄûCiche Wzg√≥rze‚Äù. Data: 16 listopada. To trzy dni temu (wynik: "+r+").");
    } else {
      type("Dostrzegasz adres nadawczy i wyra≈∫ny stempel: ‚ÄûCiche Wzg√≥rze‚Äù, data 16 listopada (wynik: "+r+").");
      type("Nagle uderza ciƒô wizja: ma≈Ça dziewczynka pochylona nad biurkiem, jej twarz jest rozmazana. Obraz znika.");
      /* üü¢ DODAJ: drobny spadek SAN przy najwy≈ºszym rzucie */
      if (window.Sanity) Sanity.add(-1, "room:envelope-stamp");
    }
  }

  function inspectLetter(){
    if(!S.lampOn){ type("Za ciemno, by cokolwiek dostrzec."); return; }
    if(!S.haveLetter){ type("Najpierw we≈∫ list."); return; }
    const r = rollOnce("letterInspectRoll");
    if(r<=2){
      type("Papier jak papier. Nic szczeg√≥lnego (wynik: "+r+").");
    } else if(r<=4){
      type("Litery sƒÖ nier√≥wne, ko≈õlawe ‚Äî zdecydowanie dzieciƒôce pismo (wynik: "+r+").");
    } else {
      type("Dzieciƒôce pismo, bez wƒÖtpienia. Ale to niemo≈ºliwe, ≈ºeby pisa≈Ça to Zosia ‚Äî zaginƒô≈Ça dekady temu. By≈Çaby ju≈º doros≈ÇƒÖ kobietƒÖ.(wynik: "+r+").");
      /* üü¢ DODAJ: drobny spadek SAN przy najwy≈ºszym rzucie */
      if (window.Sanity) Sanity.add(-1, "room:letter-handwriting");
    }
  }

function readLetter(){
  if(!S.haveLetter){ type("Najpierw we≈∫ list."); return; }
  if(!S.lampOn){ type("Za ciemno, by czytaƒá."); return; }

  // ‚ñº ZAPISZ PE≈ÅNY LIST DO EKWIPUNKU (persist miƒôdzy plikami)
  const fullText = `Cze≈õƒá, Wiem, ≈ºe my≈õlicie, ≈ºe mnie ju≈º nie ma. My≈õleli≈õcie, ≈ºe nigdy wiƒôcej o mnie nie us≈Çyszycie. Ale jestem‚Ä¶ Pamiƒôtasz tamten dzie≈Ñ? Wiem, ≈ºe pr√≥bujesz o nim zapomnieƒá. Wszyscy to robicie. Ale Ciche Wzg√≥rze nie zapomina. I ja r√≥wnie≈º nie mog≈Çam odej≈õƒá. Co≈õ mnie tu trzyma‚Ä¶ co≈õ, czego nigdy nie zrozumieli≈õcie. Sierociniec skrywa≈Ç wiƒôcej tajemnic, ni≈º kiedykolwiek sobie wyobra≈ºali≈õcie. Teraz wszystko to wychodzi na powierzchniƒô, a ja potrzebujƒô was, ≈ºeby to zako≈Ñczyƒá. Musicie wr√≥ciƒá. Nie mam zbyt wiele czasu. Znasz to miejsce, prawda? Nasze miejsce w lesie, gdzie zawsze siƒô bawili≈õmy. Gdzie wszystko siƒô zaczƒô≈Ço‚Ä¶ i gdzie wszystko musi siƒô zako≈Ñczyƒá. Przyjd≈∫cie tam. Razem. Tylko razem mo≈ºecie zrozumieƒá, co siƒô naprawdƒô wydarzy≈Ço. Musicie stawiƒá czo≈Ça temu, przed czym uciekacie od lat. Nie mo≈ºecie uciekaƒá wiecznie. Czekam na was. Zosia`;

  // Je≈õli Inventory jest podpiƒôte, zapisz list jako ‚Äûczytany‚Äù przedmiot
  if (window.Inventory) {
    Inventory.add("list Zosi", { readable: true, text: fullText });
  }

  if(!S.letterRead){
    S.letterRead = true;
    (async ()=>{
      await type(fullText);

      /* üü¢ DODAJ: spadek SAN po lekturze listu (k4) */
      if (window.Sanity) {
        const r = Math.floor(Math.random()*4)+1;
        Sanity.add(-r, "room:letter-read");
        type(`S≈Çowa pulsujƒÖ w g≈Çowie. Poczytalno≈õƒá -${r}.`);
      }

      setTimeout(()=>{
        type("Nagle za oknem rozlega siƒô metaliczny ha≈Ças ‚Äì serce podskakuje ci do gard≈Ça.");
        type("Mo≈ºesz teraz przej≈õƒá dalej przyciskiem ‚ÄûPrzejd≈∫ dalej‚Äù.");
        showContinue("pursuit.html", "Przejd≈∫ dalej");
      }, 1200);
    })();
  } else {
    type("Znasz ju≈º ka≈ºde s≈Çowo.");
  }
}
  async function readDiary(){
    if(!S.diaryRead){ type("Nie masz pamiƒôtnika."); return; }
    const entries = [
      `Poniedzia≈Çek, 13 listopada Poranek by≈Ç ciƒô≈ºki. Nie chcia≈Ço mi siƒô wstawaƒá ‚Äî i tak nikt na mnie nie czeka. Zrobi≈Çem herbatƒô, chleb by≈Ç czerstwy, ale wystarczy≈Ço by zaspokoiƒá g≈Ç√≥d. Na ulicy minƒÖ≈Çem kilku ludzi, szli razem i rozmawiali. Zazdro≈õci≈Çem im tego. W pracy nikt siƒô nie odzywa≈Ç poza kr√≥tkim ‚Äûdzie≈Ñ dobry‚Äù. Na marginesie strony kto≈õ narysowa≈Ç wysokie, krzywe drzewa.`,
      `Wtorek, 14 listopada W nocy zn√≥w mia≈Çem koszmar. Widzia≈Çem korytarze sieroci≈Ñca. Gdy siƒô obudzi≈Çem d≈Çugo patrzy≈Çem w sufit. Dopisek innƒÖ rƒôkƒÖ: ‚ÄûOni wciƒÖ≈º tu sƒÖ.‚Äù`,
      `≈öroda, 15 listopada Pada≈Ç deszcz. Zosta≈Çem w mieszkaniu, czyta≈Çem ksiƒÖ≈ºki, ale ≈ºadna nie dawa≈Ça ukojenia...`,
      `Czwartek, 16 listopada Obudzi≈Çem siƒô o trzeciej nad ranem. Na marginesie dopisane: ‚ÄûOn czeka.‚Äù`,
      `PiƒÖtek, 17 listopada W lustrze...`,
      `Sobota, 18 listopada Dzie≈Ñ wolny. Tak bardzo chcƒô odpoczƒÖƒá.`,
      `Ostatnia strona: Nie wolno patrzeƒá w lustro po zmroku.`
    ];
    for (const entry of entries){
      await type(entry);
      await new Promise(r => setTimeout(r, 600));
    }
    /* üü¢ DODAJ: lekki spadek po ostatniej stronie */
    if (window.Sanity) Sanity.add(-1, "room:diary-lastpage");
    addCommand("sp√≥jrz w lustro");
  }

  function lookMirror(){
    if(!S.diaryRead){ type("Co≈õ w tobie m√≥wi, ≈ºeby najpierw przeczytaƒá pamiƒôtnik."); return; }
    if(S.mirrorChecked){ type("Zn√≥w widzisz tylko w≈ÇasnƒÖ twarz."); return; }
    S.mirrorChecked = true;

    type("Na przek√≥r sobie idziesz do ≈Çazienki. Zbli≈ºasz siƒô do lustra...");
    showMirrorArt('mirror_art.png', 1800);

    setTimeout(()=>{
      type("W odbiciu, tu≈º obok twojego ramienia, migocze niewyra≈∫ny kszta≈Çt...");
      /* üü¢ DODAJ: mocniejszy spadek SAN przy lustrze (2k4) */
      if (window.Sanity) {
        const r = (Math.floor(Math.random()*4)+1) + (Math.floor(Math.random()*4)+1);
        Sanity.add(-r, "room:mirror");
        if (typeof Sanity.effect === "function") Sanity.effect("shake");
        type(`Czujesz zimny dreszcz. Poczytalno≈õƒá -${r}.`);
      }
    }, 350);
  }

  function searchDrawer(){
    if(!S.lampOn){ type("W ciemno≈õci nie widzisz zamka. Zapal lampkƒô."); return; }
    if(S.drawerOpen){ type("Szuflada ju≈º otwarta."); return; }
    S.drawerOpen = true;
    if(!S.keyFound){
      S.keyFound = true;
      type("Wysuwasz szufladƒô. Miƒôdzy ksiƒÖ≈ºkami znajdujesz ma≈Çy, ≈ºelazny klucz i kasetkƒô z pamiƒôtnikiem.");
      addCommand("u≈ºyj klucz");
    } else {
      type("Wysuwasz szufladƒô. WyglƒÖda na to, ≈ºe wszystko ju≈º przejrza≈Çe≈õ.");
    }
  }

  function useKey(){
    if(!S.keyFound){ type("Nie masz ≈ºadnego klucza."); return; }
    if(S.diaryRead){ type("Kasetka ju≈º otwarta."); return; }
    S.diaryRead = true;
    type("Klucz pasuje do ma≈Çej kasetki w szafce. WewnƒÖtrz znajduje siƒô stary pamiƒôtnik.");
    addCommand("czytaj pamiƒôtnik");
    // dodaj pamiƒôtnik do inventory
    if(window.Inventory) Inventory.add("pamiƒôtnik");
  }

  return {
    enter,
    handle(t){
      if(["rozejrzyj siƒô","rozejrzyj","sp√≥jrz"].includes(t)){ lookRoom(); return true; }
      if(["wsta≈Ñ","wstan"].includes(t)){ standUp(); return true; }
      if(["zapal lampkƒô","lampka"].includes(t)){ lamp(true); return true; }
      if(["zga≈õ lampkƒô"].includes(t)){ lamp(false); return true; }

      if(["we≈∫ list","wez list"].includes(t)){ takeLetter(); return true; }
      if(["przyjrzyj siƒô kopercie","koperta","obejrzyj kopertƒô","obejrzyj koperte"].includes(t)){ inspectEnvelope(); return true; }
      if(["przyjrzyj siƒô listowi","obejrzyj list"].includes(t)){ inspectLetter(); return true; }
      if(["czytaj list","czytaj"].includes(t)){ readLetter(); return true; }

      if(["przeszukaj szufladƒô","szuflada"].includes(t)){ searchDrawer(); return true; }
      if(["u≈ºyj klucz","klucz"].includes(t)){ useKey(); return true; }
      if(["czytaj pamiƒôtnik","pamiƒôtnik","pamietnik"].includes(t)){ readDiary(); return true; }
      if(["sp√≥jrz w lustro","lustro"].includes(t)){ lookMirror(); return true; }

      if(["ekwipunek","inwentarz"].includes(t)){
        const list = (window.Inventory?.list() || []);
        type(list.length ? "Ekwipunek: " + list.join(", ") : "Ekwipunek jest pusty.");
        return true;
      }

      if(["pomoc","help","?"].includes(t)){ type("Dostƒôpne komendy: " + availableCommands.join(", ")); return true; }
    }
  };
})());
  /* ===== Sterowanie / init ===== */
  speed.addEventListener('input', () => { speedIdx = +speed.value; speedLabel.textContent = labels[speedIdx]; });
  fastBtn.addEventListener('click', () => { speedIdx = 0; speed.value = 0; speedLabel.textContent = labels[0]; });
  replayBtn.addEventListener('click', () => { window.location.reload(); });

  function handleInput(){
    const t = cmd.value.trim().toLowerCase(); if(!t) return;
    writePrompt(t);
    const handled = SceneManager.handle(t);
    if(!handled){ type("Nie rozumiem. Komendy: "+availableCommands.join(", ")+"."); }
    cmd.value=""; cmd.focus();
  }
  send.addEventListener('click', handleInput);
  cmd.addEventListener('keydown', e => { if(e.key==="Enter"){ e.preventDefault(); handleInput(); } });

  // USUNIƒòTO sta≈Çy listener przekierowania ‚Äî przycisk aktywujemy dynamicznie przez showContinue()
  SceneManager.goTo("room");
})();
</script>
</body>
</html>
