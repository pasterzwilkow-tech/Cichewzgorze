<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ciche WzgÃ³rze â€” PokÃ³j</title>
<style>
  :root{ --bg:#07090c; --fg:#e6e6e6; --muted:#9aa0a6; --accent:#c7a26d; }
  *{box-sizing:border-box}
  html,body{
    height:100%; margin:0;
    background:radial-gradient(1200px 800px at 70% -10%, #11161e 0%, #07090c 60%, #05070a 100%);
    color:var(--fg);
    font:16px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Ubuntu,Cantarell
  }
  .wrap{max-width:920px; margin:0 auto; padding:24px 16px 120px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px}
  h1{font-size:20px; margin:0; letter-spacing:.02em; color:#f1f1f1}
  .pill{display:inline-block; padding:.25em .6em; border:1px solid rgba(255,255,255,.12);
    border-radius:999px; font-size:12px; color:#cbd5e1; margin-right:6px}
  .panel{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.07);
    border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,.35);
    display:flex; flex-direction:column;}
  #log{height:60vh; min-height:340px; overflow:auto; padding:18px 18px 6px; scrollbar-width:thin}
  #log::-webkit-scrollbar{height:8px; width:8px}
  #log::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1); border-radius:20px}
  .line{margin:0 0 14px; opacity:.96}
  .type{border-right:2px solid rgba(255,255,255,.65); animation:caret .85s steps(1) infinite}
  @keyframes caret{50%{border-color:transparent}}
  .toolbar{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:14px;
    padding:10px 12px; border-top:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02))}
  input[type=range]{accent-color:#b5c4ff}
  button{padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.06); color:var(--fg); cursor:pointer}
  button:hover{background:rgba(255,255,255,.1)}
  .sep{opacity:.35; margin:0 .25em}
  #inputbar{display:flex; gap:10px; padding:10px; border-top:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02))}
  #cmd{flex:1; padding:12px 14px; border-radius:10px;
    border:1px solid rgba(255,255,255,.08); background:rgba(3,6,9,.6); color:var(--fg); outline:none}
  #cmd::placeholder{color:#8892a6}
  .note{color:var(--muted); font-size:13px; margin-top:8px}

  /* overlay dla pikselartu lustra */
  .mirror-overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.85); z-index:9999; opacity:0; transition:opacity .35s ease;
  }
  .mirror-overlay.show{ opacity:1; }
  .mirror-overlay img{
    max-width:80vw; max-height:80vh; image-rendering: pixelated;
    border-radius:12px; box-shadow:0 12px 36px rgba(0,0,0,.6);
  }

  /* ðŸŸ¢ DODAJ: CSS efektÃ³w SAN (kopiuj caÅ‚oÅ›Ä‡ poniÅ¼ej) */
  /* === SANITY FX (CSS) === */
  #sanFx{position:fixed; inset:0; pointer-events:none; z-index:50}
  #sanFx .vig{position:absolute; inset:-10%; background:
    radial-gradient(70% 70% at 50% 50%, transparent 45%, rgba(0,0,0,.65) 100%);
    opacity:0; transition:opacity .35s ease}
  #sanFx .scan{position:absolute; inset:0;
    background:repeating-linear-gradient(to bottom, rgba(255,255,255,.035) 0 2px, rgba(0,0,0,0) 2px 4px);
    mix-blend-mode:overlay; opacity:0; transition:opacity .35s ease}

  body.san-t2 .panel{filter:saturate(.9) contrast(1.03)}
  body.san-t3 .panel{filter:hue-rotate(-6deg) saturate(.85) contrast(1.06)}
  body.san-t4 .panel{filter:hue-rotate(-12deg) saturate(.75) contrast(1.1) blur(.3px)}
  body.san-t5 .panel{filter:hue-rotate(-18deg) saturate(.6) contrast(1.18) blur(.6px)}
  body.san-t3 #sanFx .vig{opacity:.28}
  body.san-t4 #sanFx .vig{opacity:.5}
  body.san-t5 #sanFx .vig{opacity:.72}
  body.san-t4 #sanFx .scan{opacity:.15}
  body.san-t5 #sanFx .scan{opacity:.28}

  @keyframes sanJitter {
    0%, 97%, 100% { transform:translate3d(0,0,0) }
    98% { transform:translate3d(.6px,-.6px,0) }
    99% { transform:translate3d(-.7px,.5px,0) }
  }
  body.san-t4 .panel, body.san-t5 .panel { animation:sanJitter 7.5s infinite }
  body.san-t5 #log .line{
    text-shadow: 1px 0 rgba(255,0,0,.28), -1px 0 rgba(0,255,255,.22);
  }
  /* === /SANITY FX (CSS) === */
</style>
</head>

<!-- ðŸŸ¢ DODAJ: overlay FX tuÅ¼ po <body> -->
<body>
  <!-- SAN overlay -->
  <div id="sanFx" aria-hidden="true">
    <div class="vig"></div>
    <div class="scan"></div>
  </div>
  <!-- /SAN overlay -->

  <div class="wrap">
    <header>
      <h1>Ciche WzgÃ³rze â€” PokÃ³j</h1>
      <div>
        <!-- ðŸŸ¢ DODAJ: badge SAN w nagÅ‚Ã³wku -->
        <span class="pill" id="sanBadge" title="PoczytalnoÅ›Ä‡ (SAN)">
          <strong>SAN</strong>&nbsp;<span id="sanVal">â€”</span>
        </span>
      </div>
    </header>

    <section class="panel">
      <div id="log" aria-live="polite"></div>
      <div class="toolbar">
        <button id="replay">Restart sceny</button>
        <button id="fast">Przyspiesz</button>
        <span class="sep">|</span>
        <span>Tempo</span>
        <input type="range" id="speed" min="0" max="3" step="1" value="3" />
        <span id="speedLabel">powoli</span>
        <span class="sep">|</span>
        <button id="continue" disabled>PrzejdÅº dalej</button>
      </div>
      <div id="inputbar">
        <input id="cmd" autocomplete="off" spellcheck="false"
          placeholder="komendy: rozejrzyj siÄ™, wstaÅ„..." />
        <button id="send">WyÅ›lij</button>
      </div>
    </section>
    <p class="note" id="hint" style="display:none"></p>
  </div>

<!-- ðŸŸ¢ DODAJ: sanity.js PRZED inventory.js -->
<script src="sanity.js"></script>
<!-- === SAN PERSIST (localStorage) â€” WKLEJ TUTAJ === -->
<script>
(() => {
  const SAN_KEY = "cw.san.v1";
  const clamp = v => Math.max(0, Math.min(100, v|0));
  const loadSAN = () => {
    const raw = localStorage.getItem(SAN_KEY);
    const n = +raw;
    return Number.isFinite(n) ? clamp(n) : 100;
  };
  const saveSAN = v => { try{ localStorage.setItem(SAN_KEY, String(clamp(v))); }catch(e){} };

  // helpery globalne
  window.SAN = {
    key: SAN_KEY,
    load: loadSAN,
    save: saveSAN,
    reset(v=100){
      try{ localStorage.removeItem(SAN_KEY); }catch(e){}
      saveSAN(v);
      if (window.Sanity?.set) Sanity.set(v);
    }
  };

  // synchronizacja miÄ™dzy kartami
  window.addEventListener("storage", (e) => {
    if (e.key === SAN_KEY && e.newValue != null && window.Sanity?.set) {
      const next = clamp(+e.newValue);
      if (Number.isFinite(next) && window.Sanity?.get && Sanity.get() !== next) {
        Sanity.set(next);
      }
    }
  });
})();
</script>
<!-- PODÅÄ„CZENIE EKWIPUNKU (globalne API: window.Inventory) -->
<script src="inventory.js"></script>

<script>
(() => {
  /* ===== Typewriter / UI bazowe ===== */
  const SPEEDS = [0, 2, 10, 60];
  let speedIdx = 3;
  const labels = ["natychmiast","szybko","standard","powoli"];

  const log = document.getElementById('log');
  const replayBtn = document.getElementById('replay');
  const fastBtn = document.getElementById('fast');
  const speed = document.getElementById('speed');
  const speedLabel = document.getElementById('speedLabel');
  const continueBtn = document.getElementById('continue');
  const cmd = document.getElementById('cmd');
  const send = document.getElementById('send');
  const hint = document.getElementById('hint');

  /* ðŸŸ¢ DODAJ: SAN bootstrap (logika progÃ³w, szeptÃ³w, glitchy) */
  // ===== SANITY bootstrap =====
  const sanValElHeader = document.getElementById("sanVal");
  let sanTypeFactor = 1;
  let sanWhisperTimer = null;
  let sanScrambleTimer = null;

  function tierFor(v){ return v>=80?1 : v>=60?2 : v>=40?3 : v>=20?4 : 5; }
  function applySanityTier(t){
    document.body.classList.remove('san-t1','san-t2','san-t3','san-t4','san-t5');
    document.body.classList.add('san-t'+t);
    sanTypeFactor = [1.0, 0.95, 0.9, 0.85, 0.8][t-1] || 1;

    if (sanWhisperTimer) { clearInterval(sanWhisperTimer); sanWhisperTimer = null; }
    if (t >= 4) {
      sanWhisperTimer = setInterval(()=>{
        if (Math.random() < 0.35) {
          const pool = ["â€¦to nie onaâ€¦","â€¦nie odwracaj siÄ™â€¦","â€¦sÅ‚yszysz?â€¦","â€¦nie jesteÅ› samâ€¦","â€¦znowu patrzÄ…â€¦"];
          writeLine(`<span class="line" style="color:#aeb4bd;font-style:italic;opacity:.8">${pool[Math.floor(Math.random()*pool.length)]}</span>`);
        }
      }, 9000);
    }
    if (sanScrambleTimer) { clearInterval(sanScrambleTimer); sanScrambleTimer = null; }
    if (t === 5) {
      sanScrambleTimer = setInterval(()=> scrambleLogOnce(0.10, 160), 900);
    }
  }
  function scrambleLogOnce(intensity=0.10, duration=150){
    const spans = log?.querySelectorAll('.line span, .line') || [];
    if (!spans.length) return;
    const target = spans[Math.floor(Math.random()*spans.length)];
    const original = target.textContent;
    if (!original || original.length < 2) return;
    const idx = Math.max(1, Math.floor(original.length * intensity));
    let chars = original.split('');
    for (let i = 0; i < idx; i++) {
      const p = Math.floor(Math.random() * chars.length);
      if (!/\s/.test(chars[p])) {
        const code = chars[p].codePointAt(0);
        chars[p] = String.fromCodePoint(code + 1);
      }
    }
    target.textContent = chars.join('');
    setTimeout(() => { target.textContent = original; }, duration + Math.floor(Math.random()*120));
  }
  function syncSan(v){
    if (sanValElHeader) sanValElHeader.textContent = `${v}/100`;
    applySanityTier(tierFor(v));
  }
if (window.Sanity && typeof Sanity.init === "function") {
  // start z localStorage zamiast twardego 100
  const _startSAN = (window.SAN?.load ? window.SAN.load() : 100);
  Sanity.init({ start: _startSAN, mount: ".toolbar" });

  // zapis kaÅ¼dej zmiany + odÅ›wieÅ¼enie UI
  const _onSanChange = (v) => { try{ window.SAN?.save?.(v); }catch(e){}; syncSan(v); };

  if (typeof Sanity.subscribe === "function")      Sanity.subscribe(_onSanChange);
  else if (typeof Sanity.onChange === "function")  Sanity.onChange(_onSanChange);

  syncSan(Sanity.get?.() ?? _startSAN);
} else {
  syncSan(window.SAN?.load?.() ?? 100); // fallback teÅ¼ czyta z localStorage
}
  // ===== /SANITY bootstrap =====

  function scrollBottom(){ log.scrollTop = log.scrollHeight; }
  function writeLine(html){
    const d=document.createElement('div');
    d.className='line'; d.innerHTML=html;
    log.appendChild(d); scrollBottom(); return d;
  }
  async function typeText(text){
    const d = writeLine(""); const s=document.createElement('span');
    s.className="type"; d.appendChild(s);
    /* ðŸŸ¡ ZAMIEÅƒ: obliczanie ms (Å¼eby zaleÅ¼aÅ‚o od SAN) */
    // const ms=SPEEDS[speedIdx];
    const base = SPEEDS[speedIdx];
    const ms = Math.max(0, Math.round(base * sanTypeFactor));

    if(ms<=0){ s.textContent=text; s.classList.remove('type'); return; }
    for(const ch of text){ s.textContent+=ch; await new Promise(r=>setTimeout(r,ms)); scrollBottom(); }
    s.classList.remove('type');
  }
  function type(t){ return typeText(t); }

  /* ðŸ”µ OPCJONALNE: glitche liter przy bardzo niskim SAN (jeÅ›li sanity.js udostÄ™pnia wrapTypeText) */
  if (window.Sanity && typeof Sanity.wrapTypeText === "function") {
    const _orig = typeText;
    type = (txt)=> (Sanity.get && Sanity.get()<20 ? Sanity.wrapTypeText(_orig)(txt) : _orig(txt));
  }

  function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
  function writePrompt(t){ writeLine("&gt; "+escapeHtml(t)); }

  let availableCommands = [];
  function setCommands(arr){ availableCommands = arr.slice(); updateHint(); }
  function addCommand(c){ if(!availableCommands.includes(c)){ availableCommands.push(c); updateHint(); } }
  function updateHint(){
    hint.style.display = "block";
    hint.innerHTML = "Komendy: " + availableCommands.map(c => "<b>"+c+"</b>").join(", ") + ".";
  }

  // POMOCNICZE: aktywuj przycisk â€žPrzejdÅº dalejâ€
  function showContinue(url, label="PrzejdÅº dalej"){
    continueBtn.textContent = label;
    continueBtn.disabled = false;
    continueBtn.onclick = () => { window.location.href = url; };
  }

  // === Preload i overlay dla pixelartu lustra ===
  const preloadMirrorArt = (src='mirror_art.png') => { const i=new Image(); i.src=src; };
  preloadMirrorArt();

  function showMirrorArt(filename='mirror_art.png', visibleMs=1800){
    const overlay = document.createElement('div');
    overlay.className = 'mirror-overlay';
    overlay.innerHTML = `<img src="${filename}" alt="Pikselowy kadr: mÄ™Å¼czyzna patrzy w lustro, obok odbicia majaczy niejasna sylwetka" loading="lazy">`;
    document.body.appendChild(overlay);
    // wymuÅ› reflow i fade-in
    overlay.getBoundingClientRect();
    overlay.classList.add('show');

    const onEsc = (e)=>{ if(e.key==='Escape'){ cleanup(); } };
    document.addEventListener('keydown', onEsc);

    function cleanup(){
      overlay.classList.remove('show');
      setTimeout(()=> overlay.remove(), 300);
      document.removeEventListener('keydown', onEsc);
    }
    setTimeout(cleanup, visibleMs);
  }

  const SceneManager = {
    current:null, scenes:{},
    register(n,s){ this.scenes[n]=s; },
    async goTo(n){
      if(this.current && this.scenes[this.current].exit) this.scenes[this.current].exit();
      this.current=n; if(this.scenes[n].enter) await this.scenes[n].enter();
    },
    handle(t){
      const s = this.scenes[this.current];
      if(!s || !s.handle) return false;
      return !!s.handle(t);
    }
  };
/* ===================== SCENA: ROOM ===================== */
SceneManager.register("room", (function(){
  const S = {
    lampOn:false, haveLetter:false, letterRead:false,
    drawerOpen:false, keyFound:false, diaryRead:false,
    mirrorChecked:false,
    envelopeRoll:null, letterInspectRoll:null
  };

  function enter(){
    setCommands(["rozejrzyj siÄ™","wstaÅ„","pomoc","ekwipunek"]);
    type("Pobudka jest gwaÅ‚towna. Serce dudni ci w piersi. WokÃ³Å‚ panuje pÃ³Å‚mrok. SprÃ³buj siÄ™ rozejrzeÄ‡...");
    cmd.focus();
  }

  function lookRoom(){
    if(!S.lampOn){
      type("CiemnoÅ›Ä‡ skrywa wiÄ™kszoÅ›Ä‡ pomieszczenia. Ledwo widzisz kontury mebli. NajbliÅ¼ej ciebie stoi stolik z lampkÄ… nocnÄ….");
      addCommand("zapal lampkÄ™");
    } else {
      type("CiepÅ‚y krÄ…g Å›wiatÅ‚a odgania mrok. Na stoliku leÅ¼y koperta. Szuflada jest lekko uchylona. Budzik pokazuje: 3:03.");
    }
  }

  const standUp = ()=> type("Siadasz na Å‚Ã³Å¼ku. PodÅ‚oga skrzypi pod tobÄ….");

  function lamp(on=true){
    if(on && S.lampOn){ type("Lampka juÅ¼ Å›wieci."); return; }
    if(!on && !S.lampOn){ type("I tak jest ciemno."); return; }
    S.lampOn = on;
    if(on){
      type("Klik. ÅšwiatÅ‚o rozprasza cienie. Widzisz wyraÅºnie swoje mieszkanie. Nic specjalnego, kilka mebli, masa ksiÄ…Å¼ek, stolik z lekko uchylonÄ… szufladÄ™, a na nim kopertÄ™. PrzeÅ‚ykasz Å›linÄ™. JesteÅ› pewien, Å¼e gdy siÄ™ kÅ‚adÅ‚eÅ› jej tam nie byÅ‚o. KtoÅ› musiaÅ‚ siÄ™ zakraÅ›Ä‡ do mieszkania i jÄ… podrzuciÄ‡, kiedy spaÅ‚eÅ›.");
      addCommand("weÅº list");
      addCommand("przeszukaj szufladÄ™");
    } else {
      type("Klik. Znowu ciemno.");
    }
  }

  function takeLetter(){
    if(!S.lampOn){ type("W ciemnoÅ›ci nie chcesz grzebaÄ‡ przy stoliku. Zapal lampkÄ™."); return; }
    if(S.haveLetter){ type("List juÅ¼ masz."); return; }
    S.haveLetter = true;
    type("Bierzesz kopertÄ™. Papier jest stary i zawilgotniaÅ‚y.");
    addCommand("przyjrzyj siÄ™ kopercie");
    addCommand("przyjrzyj siÄ™ listowi");
    addCommand("czytaj list");
    // dodaj do ekwipunku
    if(window.Inventory) Inventory.add("koperta z listem");
  }

  function rollOnce(field){
    if(S[field]!==null) return S[field];
    const r = Math.floor(Math.random()*6)+1;
    S[field] = r; return r;
  }

  function inspectEnvelope(){
    if(!S.lampOn){ type("Za ciemno, Å¼eby przyglÄ…daÄ‡ siÄ™ kopercie."); return; }
    if(!S.haveLetter){ type("Najpierw weÅº kopertÄ™ ze stolika."); return; }
    const r = rollOnce("envelopeRoll");
    if(r<=2){
      type("PrzyglÄ…dasz siÄ™ kopercie, ale nic szczegÃ³lnego nie rzuca siÄ™ w oczy (wynik: "+r+").");
    } else if(r<=4){
      type("Na stemplu pocztowym widzisz: â€žCiche WzgÃ³rzeâ€. Data: 16 listopada. To trzy dni temu (wynik: "+r+").");
    } else {
      type("Dostrzegasz adres nadawczy i wyraÅºny stempel: â€žCiche WzgÃ³rzeâ€, data 16 listopada (wynik: "+r+").");
      type("Nagle uderza ciÄ™ wizja: maÅ‚a dziewczynka pochylona nad biurkiem, jej twarz jest rozmazana. Obraz znika.");
      /* ðŸŸ¢ DODAJ: drobny spadek SAN przy najwyÅ¼szym rzucie */
      if (window.Sanity) Sanity.add(-1, "room:envelope-stamp");
    }
  }

  function inspectLetter(){
    if(!S.lampOn){ type("Za ciemno, by cokolwiek dostrzec."); return; }
    if(!S.haveLetter){ type("Najpierw weÅº list."); return; }
    const r = rollOnce("letterInspectRoll");
    if(r<=2){
      type("Papier jak papier. Nic szczegÃ³lnego (wynik: "+r+").");
    } else if(r<=4){
      type("Litery sÄ… nierÃ³wne, koÅ›lawe â€” zdecydowanie dzieciÄ™ce pismo (wynik: "+r+").");
    } else {
      type("DzieciÄ™ce pismo, bez wÄ…tpienia. Ale to niemoÅ¼liwe, Å¼eby pisaÅ‚a to Zosia â€” zaginÄ™Å‚a dekady temu. ByÅ‚aby juÅ¼ dorosÅ‚Ä… kobietÄ….(wynik: "+r+").");
      /* ðŸŸ¢ DODAJ: drobny spadek SAN przy najwyÅ¼szym rzucie */
      if (window.Sanity) Sanity.add(-1, "room:letter-handwriting");
    }
  }

function readLetter(){
  if(!S.haveLetter){ type("Najpierw weÅº list."); return; }
  if(!S.lampOn){ type("Za ciemno, by czytaÄ‡."); return; }

  // â–¼ ZAPISZ PEÅNY LIST DO EKWIPUNKU (persist miÄ™dzy plikami)
  const fullText = `CzeÅ›Ä‡, Wiem, Å¼e myÅ›licie, Å¼e mnie juÅ¼ nie ma. MyÅ›leliÅ›cie, Å¼e nigdy wiÄ™cej o mnie nie usÅ‚yszycie. Ale jestemâ€¦ PamiÄ™tasz tamten dzieÅ„? Wiem, Å¼e prÃ³bujesz o nim zapomnieÄ‡. Wszyscy to robicie. Ale Ciche WzgÃ³rze nie zapomina. I ja rÃ³wnieÅ¼ nie mogÅ‚am odejÅ›Ä‡. CoÅ› mnie tu trzymaâ€¦ coÅ›, czego nigdy nie zrozumieliÅ›cie. Sierociniec skrywaÅ‚ wiÄ™cej tajemnic, niÅ¼ kiedykolwiek sobie wyobraÅ¼aliÅ›cie. Teraz wszystko to wychodzi na powierzchniÄ™, a ja potrzebujÄ™ was, Å¼eby to zakoÅ„czyÄ‡. Musicie wrÃ³ciÄ‡. Nie mam zbyt wiele czasu. Znasz to miejsce, prawda? Nasze miejsce w lesie, gdzie zawsze siÄ™ bawiliÅ›my. Gdzie wszystko siÄ™ zaczÄ™Å‚oâ€¦ i gdzie wszystko musi siÄ™ zakoÅ„czyÄ‡. PrzyjdÅºcie tam. Razem. Tylko razem moÅ¼ecie zrozumieÄ‡, co siÄ™ naprawdÄ™ wydarzyÅ‚o. Musicie stawiÄ‡ czoÅ‚a temu, przed czym uciekacie od lat. Nie moÅ¼ecie uciekaÄ‡ wiecznie. Czekam na was. Zosia`;

  // JeÅ›li Inventory jest podpiÄ™te, zapisz list jako â€žczytanyâ€ przedmiot
  if (window.Inventory) {
    Inventory.add("list Zosi", { readable: true, text: fullText });
  }

  if(!S.letterRead){
    S.letterRead = true;
    (async ()=>{
      await type(fullText);

      /* ðŸŸ¢ DODAJ: spadek SAN po lekturze listu (k4) */
      if (window.Sanity) {
        const r = Math.floor(Math.random()*4)+1;
        Sanity.add(-r, "room:letter-read");
        type(`SÅ‚owa pulsujÄ… w gÅ‚owie. PoczytalnoÅ›Ä‡ -${r}.`);
      }

      setTimeout(()=>{
        type("Nagle za oknem rozlega siÄ™ metaliczny haÅ‚as â€“ serce podskakuje ci do gardÅ‚a.");
        type("MoÅ¼esz teraz przejÅ›Ä‡ dalej przyciskiem â€žPrzejdÅº dalejâ€.");
        showContinue("pursuit.html", "PrzejdÅº dalej");
      }, 1200);
    })();
  } else {
    type("Znasz juÅ¼ kaÅ¼de sÅ‚owo.");
  }
}
  async function readDiary(){
    if(!S.diaryRead){ type("Nie masz pamiÄ™tnika."); return; }
    const entries = [
      `PoniedziaÅ‚ek, 13 listopada Poranek byÅ‚ ciÄ™Å¼ki. Nie chciaÅ‚o mi siÄ™ wstawaÄ‡ â€” i tak nikt na mnie nie czeka. ZrobiÅ‚em herbatÄ™, chleb byÅ‚ czerstwy, ale wystarczyÅ‚o by zaspokoiÄ‡ gÅ‚Ã³d. Na ulicy minÄ…Å‚em kilku ludzi, szli razem i rozmawiali. ZazdroÅ›ciÅ‚em im tego. W pracy nikt siÄ™ nie odzywaÅ‚ poza krÃ³tkim â€ždzieÅ„ dobryâ€. Na marginesie strony ktoÅ› narysowaÅ‚ wysokie, krzywe drzewa.`,
      `Wtorek, 14 listopada W nocy znÃ³w miaÅ‚em koszmar. WidziaÅ‚em korytarze sierociÅ„ca. Gdy siÄ™ obudziÅ‚em dÅ‚ugo patrzyÅ‚em w sufit. Dopisek innÄ… rÄ™kÄ…: â€žOni wciÄ…Å¼ tu sÄ….â€`,
      `Åšroda, 15 listopada PadaÅ‚ deszcz. ZostaÅ‚em w mieszkaniu, czytaÅ‚em ksiÄ…Å¼ki, ale Å¼adna nie dawaÅ‚a ukojenia...`,
      `Czwartek, 16 listopada ObudziÅ‚em siÄ™ o trzeciej nad ranem. Na marginesie dopisane: â€žOn czeka.â€`,
      `PiÄ…tek, 17 listopada W lustrze...`,
      `Sobota, 18 listopada DzieÅ„ wolny. Tak bardzo chcÄ™ odpoczÄ…Ä‡.`,
      `Ostatnia strona: Nie wolno patrzeÄ‡ w lustro po zmroku.`
    ];
    for (const entry of entries){
      await type(entry);
      await new Promise(r => setTimeout(r, 600));
    }
    /* ðŸŸ¢ DODAJ: lekki spadek po ostatniej stronie */
    if (window.Sanity) Sanity.add(-1, "room:diary-lastpage");
    addCommand("spÃ³jrz w lustro");
  }

  function lookMirror(){
    if(!S.diaryRead){ type("CoÅ› w tobie mÃ³wi, Å¼eby najpierw przeczytaÄ‡ pamiÄ™tnik."); return; }
    if(S.mirrorChecked){ type("ZnÃ³w widzisz tylko wÅ‚asnÄ… twarz."); return; }
    S.mirrorChecked = true;

    type("Na przekÃ³r sobie idziesz do Å‚azienki. ZbliÅ¼asz siÄ™ do lustra...");
    showMirrorArt('mirror_art.png', 1800);

    setTimeout(()=>{
      type("W odbiciu, tuÅ¼ obok twojego ramienia, migocze niewyraÅºny ksztaÅ‚t...");
      /* ðŸŸ¢ DODAJ: mocniejszy spadek SAN przy lustrze (2k4) */
      if (window.Sanity) {
        const r = (Math.floor(Math.random()*4)+1) + (Math.floor(Math.random()*4)+1);
        Sanity.add(-r, "room:mirror");
        if (typeof Sanity.effect === "function") Sanity.effect("shake");
        type(`Czujesz zimny dreszcz. PoczytalnoÅ›Ä‡ -${r}.`);
      }
    }, 350);
  }

  function searchDrawer(){
    if(!S.lampOn){ type("W ciemnoÅ›ci nie widzisz zamka. Zapal lampkÄ™."); return; }
    if(S.drawerOpen){ type("Szuflada juÅ¼ otwarta."); return; }
    S.drawerOpen = true;
    if(!S.keyFound){
      S.keyFound = true;
      type("Wysuwasz szufladÄ™. MiÄ™dzy ksiÄ…Å¼kami znajdujesz maÅ‚y, Å¼elazny klucz i kasetkÄ™ z pamiÄ™tnikiem.");
      addCommand("uÅ¼yj klucz");
    } else {
      type("Wysuwasz szufladÄ™. WyglÄ…da na to, Å¼e wszystko juÅ¼ przejrzaÅ‚eÅ›.");
    }
  }

  function useKey(){
    if(!S.keyFound){ type("Nie masz Å¼adnego klucza."); return; }
    if(S.diaryRead){ type("Kasetka juÅ¼ otwarta."); return; }
    S.diaryRead = true;
    type("Klucz pasuje do maÅ‚ej kasetki w szafce. WewnÄ…trz znajduje siÄ™ stary pamiÄ™tnik.");
    addCommand("czytaj pamiÄ™tnik");
    // dodaj pamiÄ™tnik do inventory
    if(window.Inventory) Inventory.add("pamiÄ™tnik");
  }

  return {
    enter,
    handle(t){
      if(["rozejrzyj siÄ™","rozejrzyj","spÃ³jrz"].includes(t)){ lookRoom(); return true; }
      if(["wstaÅ„","wstan"].includes(t)){ standUp(); return true; }
      if(["zapal lampkÄ™","lampka"].includes(t)){ lamp(true); return true; }
      if(["zgaÅ› lampkÄ™"].includes(t)){ lamp(false); return true; }

      if(["weÅº list","wez list"].includes(t)){ takeLetter(); return true; }
      if(["przyjrzyj siÄ™ kopercie","koperta","obejrzyj kopertÄ™","obejrzyj koperte"].includes(t)){ inspectEnvelope(); return true; }
      if(["przyjrzyj siÄ™ listowi","obejrzyj list"].includes(t)){ inspectLetter(); return true; }
      if(["czytaj list","czytaj"].includes(t)){ readLetter(); return true; }

      if(["przeszukaj szufladÄ™","szuflada"].includes(t)){ searchDrawer(); return true; }
      if(["uÅ¼yj klucz","klucz"].includes(t)){ useKey(); return true; }
      if(["czytaj pamiÄ™tnik","pamiÄ™tnik","pamietnik"].includes(t)){ readDiary(); return true; }
      if(["spÃ³jrz w lustro","lustro"].includes(t)){ lookMirror(); return true; }

      if(["ekwipunek","inwentarz"].includes(t)){
        const list = (window.Inventory?.list() || []);
        type(list.length ? "Ekwipunek: " + list.join(", ") : "Ekwipunek jest pusty.");
        return true;
      }

      if(["pomoc","help","?"].includes(t)){ type("DostÄ™pne komendy: " + availableCommands.join(", ")); return true; }
    }
  };
})());
  /* ===== Sterowanie / init ===== */
  speed.addEventListener('input', () => { speedIdx = +speed.value; speedLabel.textContent = labels[speedIdx]; });
  fastBtn.addEventListener('click', () => { speedIdx = 0; speed.value = 0; speedLabel.textContent = labels[0]; });
  replayBtn.addEventListener('click', () => { window.location.reload(); });

  function handleInput(){
    const t = cmd.value.trim().toLowerCase(); if(!t) return;
    writePrompt(t);
    const handled = SceneManager.handle(t);
    if(!handled){ type("Nie rozumiem. Komendy: "+availableCommands.join(", ")+"."); }
    cmd.value=""; cmd.focus();
  }
  send.addEventListener('click', handleInput);
  cmd.addEventListener('keydown', e => { if(e.key==="Enter"){ e.preventDefault(); handleInput(); } });

  // USUNIÄ˜TO staÅ‚y listener przekierowania â€” przycisk aktywujemy dynamicznie przez showContinue()
  SceneManager.goTo("room");
})();
</script>
</body>
</html>
